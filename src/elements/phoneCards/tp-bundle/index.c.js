"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Rt=require("axios");function Et(t){return t&&typeof t=="object"&&"default"in t?t:{default:t}}var ne=Et(Rt);const x={WEBRTC_NOT_SUPPORT:"WEBRTC_NOT_SUPPORT",WEBRTC_ICE_CANDIDATE_ERROR:"WEBRTC_ICE_CANDIDATE_ERROR",WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED:"WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED",WEBRTC_ON_REMOTE_STREAMS:"WEBRTC_ON_REMOTE_STREAMS",WEBRTC_ON_LOCAL_STREAM:"WEBRTC_ON_LOCAL_STREAM",WEBRTC_ON_CONNECTION_STATE_CHANGE:"WEBRTC_ON_CONNECTION_STATE_CHANGE",CAPTURE_STREAM_FAILED:"CAPTURE_STREAM_FAILED"};function Se(){return window.navigator.userAgent.match("Firefox")!==null}function Pt(){return window.navigator.userAgent.match("Chrome")!==null}function _t(){return window.navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)!==null}const O={MIC:"mic",SCREENCAST:"screen-cast",FILE:"file",MIXED:"mixed"},A={CAMERA:"camera",SCREENCAST:"screen-cast",FILE:"file",MIXED:"mixed"},bt={AUDIO:"audio",VIDEO:"video",AUDIO_AND_VIDEO:"av"};class Oe{constructor(r,e){this.width=r,this.height=e}}function z(t,r,e){const n=t.match(r);return n&&n.length>=e&&parseInt(n[e],10)}function F(t,r,e){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype,o=n.addEventListener;n.addEventListener=function(c,p){if(c!==r)return o.apply(this,arguments);const a=i=>{const d=e(i);d&&(p.handleEvent?p.handleEvent(d):p(d))};return this._eventMap=this._eventMap||{},this._eventMap[r]||(this._eventMap[r]=new Map),this._eventMap[r].set(p,a),o.apply(this,[c,a])};const s=n.removeEventListener;n.removeEventListener=function(c,p){if(c!==r||!this._eventMap||!this._eventMap[r])return s.apply(this,arguments);if(!this._eventMap[r].has(p))return s.apply(this,arguments);const a=this._eventMap[r].get(p);return this._eventMap[r].delete(p),this._eventMap[r].size===0&&delete this._eventMap[r],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[c,a])},Object.defineProperty(n,"on"+r,{get(){return this["_on"+r]},set(c){this["_on"+r]&&(this.removeEventListener(r,this["_on"+r]),delete this["_on"+r]),c&&this.addEventListener(r,this["_on"+r]=c)},enumerable:!0,configurable:!0})}function wt(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):t?"adapter.js logging disabled":"adapter.js logging enabled"}function kt(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):"adapter.js deprecation warnings "+(t?"disabled":"enabled")}function Dt(){}function It(t){const r={browser:null,version:null};if(typeof t>"u"||!t.navigator)return r.browser="Not a browser.",r;const{navigator:e}=t;if(e.mozGetUserMedia)r.browser="firefox",r.version=z(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||t.isSecureContext===!1&&t.webkitRTCPeerConnection&&!t.RTCIceGatherer)r.browser="chrome",r.version=z(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(e.mediaDevices&&e.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=z(e.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(t.RTCPeerConnection&&e.userAgent.match(/AppleWebKit\/(\d+)\./))r.browser="safari",r.version=z(e.userAgent,/AppleWebKit\/(\d+)\./,1),r.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype;else return r.browser="Not a supported browser.",r;return r}function Re(t){return Object.prototype.toString.call(t)==="[object Object]"}function xe(t){return Re(t)?Object.keys(t).reduce(function(r,e){const n=Re(t[e]),o=n?xe(t[e]):t[e],s=n&&!Object.keys(o).length;return o===void 0||s?r:Object.assign(r,{[e]:o})},{}):t}function ie(t,r,e){!r||e.has(r.id)||(e.set(r.id,r),Object.keys(r).forEach(n=>{n.endsWith("Id")?ie(t,t.get(r[n]),e):n.endsWith("Ids")&&r[n].forEach(o=>{ie(t,t.get(o),e)})}))}function Ee(t,r,e){const n=e?"outbound-rtp":"inbound-rtp",o=new Map;if(r===null)return o;const s=[];return t.forEach(c=>{c.type==="track"&&c.trackIdentifier===r.id&&s.push(c)}),s.forEach(c=>{t.forEach(p=>{p.type===n&&p.trackId===c.id&&ie(t,p,o)})}),o}const Pe=Dt;function Me(t,r){const e=t&&t.navigator;if(!e.mediaDevices)return;const n=function(p){if(typeof p!="object"||p.mandatory||p.optional)return p;const a={};return Object.keys(p).forEach(i=>{if(i==="require"||i==="advanced"||i==="mediaSource")return;const d=typeof p[i]=="object"?p[i]:{ideal:p[i]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const u=function(l,h){return l?l+h.charAt(0).toUpperCase()+h.slice(1):h==="deviceId"?"sourceId":h};if(d.ideal!==void 0){a.optional=a.optional||[];let l={};typeof d.ideal=="number"?(l[u("min",i)]=d.ideal,a.optional.push(l),l={},l[u("max",i)]=d.ideal,a.optional.push(l)):(l[u("",i)]=d.ideal,a.optional.push(l))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[u("",i)]=d.exact):["min","max"].forEach(l=>{d[l]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[u(l,i)]=d[l])})}),p.advanced&&(a.optional=(a.optional||[]).concat(p.advanced)),a},o=function(p,a){if(r.version>=61)return a(p);if(p=JSON.parse(JSON.stringify(p)),p&&typeof p.audio=="object"){const i=function(d,u,l){u in d&&!(l in d)&&(d[l]=d[u],delete d[u])};p=JSON.parse(JSON.stringify(p)),i(p.audio,"autoGainControl","googAutoGainControl"),i(p.audio,"noiseSuppression","googNoiseSuppression"),p.audio=n(p.audio)}if(p&&typeof p.video=="object"){let i=p.video.facingMode;i=i&&(typeof i=="object"?i:{ideal:i});const d=r.version<66;if(i&&(i.exact==="user"||i.exact==="environment"||i.ideal==="user"||i.ideal==="environment")&&!(e.mediaDevices.getSupportedConstraints&&e.mediaDevices.getSupportedConstraints().facingMode&&!d)){delete p.video.facingMode;let u;if(i.exact==="environment"||i.ideal==="environment"?u=["back","rear"]:(i.exact==="user"||i.ideal==="user")&&(u=["front"]),u)return e.mediaDevices.enumerateDevices().then(l=>{l=l.filter(f=>f.kind==="videoinput");let h=l.find(f=>u.some(y=>f.label.toLowerCase().includes(y)));return!h&&l.length&&u.includes("back")&&(h=l[l.length-1]),h&&(p.video.deviceId=i.exact?{exact:h.deviceId}:{ideal:h.deviceId}),p.video=n(p.video),Pe("chrome: "+JSON.stringify(p)),a(p)})}p.video=n(p.video)}return Pe("chrome: "+JSON.stringify(p)),a(p)},s=function(p){return r.version>=64?p:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[p.name]||p.name,message:p.message,constraint:p.constraint||p.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},c=function(p,a,i){o(p,d=>{e.webkitGetUserMedia(d,a,u=>{i&&i(s(u))})})};if(e.getUserMedia=c.bind(e),e.mediaDevices.getUserMedia){const p=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(a){return o(a,i=>p(i).then(d=>{if(i.audio&&!d.getAudioTracks().length||i.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(u=>{u.stop()}),new DOMException("","NotFoundError");return d},d=>Promise.reject(s(d))))}}}function Ot(t,r){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&typeof r=="function"&&(t.navigator.mediaDevices.getDisplayMedia=function(e){return r(e).then(n=>{const o=e.video&&e.video.width,s=e.video&&e.video.height,c=e.video&&e.video.frameRate;return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:c||3}},o&&(e.video.mandatory.maxWidth=o),s&&(e.video.mandatory.maxHeight=s),t.navigator.mediaDevices.getUserMedia(e)})})}function Ae(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function Le(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",n=>{let o;t.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(c=>c.track&&c.track.id===n.track.id):o={track:n.track};const s=new Event("track");s.track=n.track,s.receiver=o,s.transceiver={receiver:o},s.streams=[e.stream],this.dispatchEvent(s)}),e.stream.getTracks().forEach(n=>{let o;t.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(c=>c.track&&c.track.id===n.id):o={track:n};const s=new Event("track");s.track=n,s.receiver=o,s.transceiver={receiver:o},s.streams=[e.stream],this.dispatchEvent(s)})},this.addEventListener("addstream",this._ontrackpoly)),r.apply(this,arguments)}}else F(t,"track",r=>(r.transceiver||Object.defineProperty(r,"transceiver",{value:{receiver:r.receiver}}),r))}function je(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const r=function(o,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=o.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:o}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const o=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(c,p){let a=o.apply(this,arguments);return a||(a=r(this,c),this._senders.push(a)),a};const s=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(c){s.apply(this,arguments);const p=this._senders.indexOf(c);p!==-1&&this._senders.splice(p,1)}}const e=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._senders=this._senders||[],e.apply(this,[o]),o.getTracks().forEach(s=>{this._senders.push(r(this,s))})};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){this._senders=this._senders||[],n.apply(this,[o]),o.getTracks().forEach(s=>{const c=this._senders.find(p=>p.track===s);c&&this._senders.splice(this._senders.indexOf(c),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const r=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const e=r.apply(this,[]);return e.forEach(n=>n._pc=this),e},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Ne(t){if(!t.RTCPeerConnection)return;const r=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[e,n,o]=arguments;if(arguments.length>0&&typeof e=="function")return r.apply(this,arguments);if(r.length===0&&(arguments.length===0||typeof e!="function"))return r.apply(this,[]);const s=function(p){const a={};return p.result().forEach(i=>{const d={id:i.id,timestamp:i.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[i.type]||i.type};i.names().forEach(u=>{d[u]=i.stat(u)}),a[d.id]=d}),a},c=function(p){return new Map(Object.keys(p).map(a=>[a,p[a]]))};if(arguments.length>=2){const p=function(a){n(c(s(a)))};return r.apply(this,[p,e])}return new Promise((p,a)=>{r.apply(this,[function(i){p(c(s(i)))},a])}).then(n,o)}}function Ge(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const o=e.apply(this,[]);return o.forEach(s=>s._pc=this),o});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const o=n.apply(this,arguments);return o._pc=this,o}),t.RTCRtpSender.prototype.getStats=function(){const o=this;return this._pc.getStats().then(s=>Ee(s,o.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(o=>o._pc=this),n}),F(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(o=>Ee(o,n.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype&&"getStats"in t.RTCRtpReceiver.prototype))return;const r=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const e=arguments[0];let n,o,s;return this.getSenders().forEach(c=>{c.track===e&&(n?s=!0:n=c)}),this.getReceivers().forEach(c=>(c.track===e&&(o?s=!0:o=c),c.track===e)),s||n&&o?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():o?o.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return r.apply(this,arguments)}}function Fe(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(s=>this._shimmedLocalStreams[s][0])};const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,c){if(!c)return r.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const p=r.apply(this,arguments);return this._shimmedLocalStreams[c.id]?this._shimmedLocalStreams[c.id].indexOf(p)===-1&&this._shimmedLocalStreams[c.id].push(p):this._shimmedLocalStreams[c.id]=[c,p],p};const e=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach(a=>{if(this.getSenders().find(i=>i.track===a))throw new DOMException("Track already exists.","InvalidAccessError")});const c=this.getSenders();e.apply(this,arguments);const p=this.getSenders().filter(a=>c.indexOf(a)===-1);this._shimmedLocalStreams[s.id]=[s].concat(p)};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],n.apply(this,arguments)};const o=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach(c=>{const p=this._shimmedLocalStreams[c].indexOf(s);p!==-1&&this._shimmedLocalStreams[c].splice(p,1),this._shimmedLocalStreams[c].length===1&&delete this._shimmedLocalStreams[c]}),o.apply(this,arguments)}}function Ve(t,r){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&r.version>=65)return Fe(t);const e=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const i=e.apply(this);return this._reverseStreams=this._reverseStreams||{},i.map(d=>this._reverseStreams[d.id])};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(i){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[i.id]){const d=new t.MediaStream(i.getTracks());this._streams[i.id]=d,this._reverseStreams[d.id]=i,i=d}n.apply(this,[i])};const o=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(i){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},o.apply(this,[this._streams[i.id]||i]),delete this._reverseStreams[this._streams[i.id]?this._streams[i.id].id:i.id],delete this._streams[i.id]},t.RTCPeerConnection.prototype.addTrack=function(i,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const u=[].slice.call(arguments,1);if(u.length!==1||!u[0].getTracks().find(h=>h===i))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(h=>h.track===i))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const l=this._streams[d.id];if(l)l.addTrack(i),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const h=new t.MediaStream([i]);this._streams[d.id]=h,this._reverseStreams[h.id]=d,this.addStream(h)}return this.getSenders().find(h=>h.track===i)};function s(i,d){let u=d.sdp;return Object.keys(i._reverseStreams||[]).forEach(l=>{const h=i._reverseStreams[l],f=i._streams[h.id];u=u.replace(new RegExp(f.id,"g"),h.id)}),new RTCSessionDescription({type:d.type,sdp:u})}function c(i,d){let u=d.sdp;return Object.keys(i._reverseStreams||[]).forEach(l=>{const h=i._reverseStreams[l],f=i._streams[h.id];u=u.replace(new RegExp(h.id,"g"),f.id)}),new RTCSessionDescription({type:d.type,sdp:u})}["createOffer","createAnswer"].forEach(function(i){const d=t.RTCPeerConnection.prototype[i],u={[i](){const l=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[h=>{const f=s(this,h);l[0].apply(null,[f])},h=>{l[1]&&l[1].apply(null,h)},arguments[2]]):d.apply(this,arguments).then(h=>s(this,h))}};t.RTCPeerConnection.prototype[i]=u[i]});const p=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?p.apply(this,arguments):(arguments[0]=c(this,arguments[0]),p.apply(this,arguments))};const a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const i=a.get.apply(this);return i.type===""?i:s(this,i)}}),t.RTCPeerConnection.prototype.removeTrack=function(i){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!i._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(i._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let d;Object.keys(this._streams).forEach(u=>{this._streams[u].getTracks().find(l=>i.track===l)&&(d=this._streams[u])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(i.track),this.dispatchEvent(new Event("negotiationneeded")))}}function ae(t,r){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&r.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){const n=t.RTCPeerConnection.prototype[e],o={[e](){return arguments[0]=new(e==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=o[e]})}function Ue(t,r){F(t,"negotiationneeded",e=>{const n=e.target;if(!((r.version<72||n.getConfiguration&&n.getConfiguration().sdpSemantics==="plan-b")&&n.signalingState!=="stable"))return e})}var _e=Object.freeze({__proto__:null,shimMediaStream:Ae,shimOnTrack:Le,shimGetSendersWithDtmf:je,shimGetStats:Ne,shimSenderReceiverGetStats:Ge,shimAddTrackRemoveTrackWithNative:Fe,shimAddTrackRemoveTrack:Ve,shimPeerConnection:ae,fixNegotiationNeeded:Ue,shimGetUserMedia:Me,shimGetDisplayMedia:Ot});function xt(t,r){let e=!1;return t=JSON.parse(JSON.stringify(t)),t.filter(n=>{if(n&&(n.urls||n.url)){let o=n.urls||n.url;n.url&&n.urls;const s=typeof o=="string";return s&&(o=[o]),o=o.filter(c=>{if(c.indexOf("stun:")===0)return!1;const p=c.startsWith("turn")&&!c.startsWith("turn:[")&&c.includes("transport=udp");return p&&!e?(e=!0,!0):p&&!e}),delete n.url,n.urls=s?o[0]:o,!!o.length}})}function Mt(t){var r={exports:{}};return t(r,r.exports),r.exports}var m=Mt(function(t){var r={};r.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},r.localCName=r.generateIdentifier(),r.splitLines=function(e){return e.trim().split(`
`).map(function(n){return n.trim()})},r.splitSections=function(e){var n=e.split(`
m=`);return n.map(function(o,s){return(s>0?"m="+o:o).trim()+`\r
`})},r.getDescription=function(e){var n=r.splitSections(e);return n&&n[0]},r.getMediaSections=function(e){var n=r.splitSections(e);return n.shift(),n},r.matchPrefix=function(e,n){return r.splitLines(e).filter(function(o){return o.indexOf(n)===0})},r.parseCandidate=function(e){var n;e.indexOf("a=candidate:")===0?n=e.substring(12).split(" "):n=e.substring(10).split(" ");for(var o={foundation:n[0],component:parseInt(n[1],10),protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]},s=8;s<n.length;s+=2)switch(n[s]){case"raddr":o.relatedAddress=n[s+1];break;case"rport":o.relatedPort=parseInt(n[s+1],10);break;case"tcptype":o.tcpType=n[s+1];break;case"ufrag":o.ufrag=n[s+1],o.usernameFragment=n[s+1];break;default:o[n[s]]=n[s+1];break}return o},r.writeCandidate=function(e){var n=[];n.push(e.foundation),n.push(e.component),n.push(e.protocol.toUpperCase()),n.push(e.priority),n.push(e.address||e.ip),n.push(e.port);var o=e.type;return n.push("typ"),n.push(o),o!=="host"&&e.relatedAddress&&e.relatedPort&&(n.push("raddr"),n.push(e.relatedAddress),n.push("rport"),n.push(e.relatedPort)),e.tcpType&&e.protocol.toLowerCase()==="tcp"&&(n.push("tcptype"),n.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(n.push("ufrag"),n.push(e.usernameFragment||e.ufrag)),"candidate:"+n.join(" ")},r.parseIceOptions=function(e){return e.substr(14).split(" ")},r.parseRtpMap=function(e){var n=e.substr(9).split(" "),o={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),o.name=n[0],o.clockRate=parseInt(n[1],10),o.channels=n.length===3?parseInt(n[2],10):1,o.numChannels=o.channels,o},r.writeRtpMap=function(e){var n=e.payloadType;e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType);var o=e.channels||e.numChannels||1;return"a=rtpmap:"+n+" "+e.name+"/"+e.clockRate+(o!==1?"/"+o:"")+`\r
`},r.parseExtmap=function(e){var n=e.substr(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1]}},r.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+`\r
`},r.parseFmtp=function(e){for(var n={},o,s=e.substr(e.indexOf(" ")+1).split(";"),c=0;c<s.length;c++)o=s[c].trim().split("="),n[o[0].trim()]=o[1];return n},r.writeFmtp=function(e){var n="",o=e.payloadType;if(e.preferredPayloadType!==void 0&&(o=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var s=[];Object.keys(e.parameters).forEach(function(c){e.parameters[c]?s.push(c+"="+e.parameters[c]):s.push(c)}),n+="a=fmtp:"+o+" "+s.join(";")+`\r
`}return n},r.parseRtcpFb=function(e){var n=e.substr(e.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},r.writeRtcpFb=function(e){var n="",o=e.payloadType;return e.preferredPayloadType!==void 0&&(o=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(s){n+="a=rtcp-fb:"+o+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),n},r.parseSsrcMedia=function(e){var n=e.indexOf(" "),o={ssrc:parseInt(e.substr(7,n-7),10)},s=e.indexOf(":",n);return s>-1?(o.attribute=e.substr(n+1,s-n-1),o.value=e.substr(s+1)):o.attribute=e.substr(n+1),o},r.parseSsrcGroup=function(e){var n=e.substr(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(function(o){return parseInt(o,10)})}},r.getMid=function(e){var n=r.matchPrefix(e,"a=mid:")[0];if(n)return n.substr(6)},r.parseFingerprint=function(e){var n=e.substr(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1]}},r.getDtlsParameters=function(e,n){var o=r.matchPrefix(e+n,"a=fingerprint:");return{role:"auto",fingerprints:o.map(r.parseFingerprint)}},r.writeDtlsParameters=function(e,n){var o="a=setup:"+n+`\r
`;return e.fingerprints.forEach(function(s){o+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),o},r.parseCryptoLine=function(e){var n=e.substr(9).split(" ");return{tag:parseInt(n[0],10),cryptoSuite:n[1],keyParams:n[2],sessionParams:n.slice(3)}},r.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams=="object"?r.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+`\r
`},r.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;var n=e.substr(7).split("|");return{keyMethod:"inline",keySalt:n[0],lifeTime:n[1],mkiValue:n[2]?n[2].split(":")[0]:void 0,mkiLength:n[2]?n[2].split(":")[1]:void 0}},r.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},r.getCryptoParameters=function(e,n){var o=r.matchPrefix(e+n,"a=crypto:");return o.map(r.parseCryptoLine)},r.getIceParameters=function(e,n){var o=r.matchPrefix(e+n,"a=ice-ufrag:")[0],s=r.matchPrefix(e+n,"a=ice-pwd:")[0];return o&&s?{usernameFragment:o.substr(12),password:s.substr(10)}:null},r.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+`\r
a=ice-pwd:`+e.password+`\r
`},r.parseRtpParameters=function(e){for(var n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},o=r.splitLines(e),s=o[0].split(" "),c=3;c<s.length;c++){var p=s[c],a=r.matchPrefix(e,"a=rtpmap:"+p+" ")[0];if(a){var i=r.parseRtpMap(a),d=r.matchPrefix(e,"a=fmtp:"+p+" ");switch(i.parameters=d.length?r.parseFmtp(d[0]):{},i.rtcpFeedback=r.matchPrefix(e,"a=rtcp-fb:"+p+" ").map(r.parseRtcpFb),n.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(i.name.toUpperCase());break}}}return r.matchPrefix(e,"a=extmap:").forEach(function(u){n.headerExtensions.push(r.parseExtmap(u))}),n},r.writeRtpDescription=function(e,n){var o="";o+="m="+e+" ",o+=n.codecs.length>0?"9":"0",o+=" UDP/TLS/RTP/SAVPF ",o+=n.codecs.map(function(c){return c.preferredPayloadType!==void 0?c.preferredPayloadType:c.payloadType}).join(" ")+`\r
`,o+=`c=IN IP4 0.0.0.0\r
`,o+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,n.codecs.forEach(function(c){o+=r.writeRtpMap(c),o+=r.writeFmtp(c),o+=r.writeRtcpFb(c)});var s=0;return n.codecs.forEach(function(c){c.maxptime>s&&(s=c.maxptime)}),s>0&&(o+="a=maxptime:"+s+`\r
`),o+=`a=rtcp-mux\r
`,n.headerExtensions&&n.headerExtensions.forEach(function(c){o+=r.writeExtmap(c)}),o},r.parseRtpEncodingParameters=function(e){var n=[],o=r.parseRtpParameters(e),s=o.fecMechanisms.indexOf("RED")!==-1,c=o.fecMechanisms.indexOf("ULPFEC")!==-1,p=r.matchPrefix(e,"a=ssrc:").map(function(l){return r.parseSsrcMedia(l)}).filter(function(l){return l.attribute==="cname"}),a=p.length>0&&p[0].ssrc,i,d=r.matchPrefix(e,"a=ssrc-group:FID").map(function(l){var h=l.substr(17).split(" ");return h.map(function(f){return parseInt(f,10)})});d.length>0&&d[0].length>1&&d[0][0]===a&&(i=d[0][1]),o.codecs.forEach(function(l){if(l.name.toUpperCase()==="RTX"&&l.parameters.apt){var h={ssrc:a,codecPayloadType:parseInt(l.parameters.apt,10)};a&&i&&(h.rtx={ssrc:i}),n.push(h),s&&(h=JSON.parse(JSON.stringify(h)),h.fec={ssrc:a,mechanism:c?"red+ulpfec":"red"},n.push(h))}}),n.length===0&&a&&n.push({ssrc:a});var u=r.matchPrefix(e,"b=");return u.length&&(u[0].indexOf("b=TIAS:")===0?u=parseInt(u[0].substr(7),10):u[0].indexOf("b=AS:")===0?u=parseInt(u[0].substr(5),10)*1e3*.95-50*40*8:u=void 0,n.forEach(function(l){l.maxBitrate=u})),n},r.parseRtcpParameters=function(e){var n={},o=r.matchPrefix(e,"a=ssrc:").map(function(p){return r.parseSsrcMedia(p)}).filter(function(p){return p.attribute==="cname"})[0];o&&(n.cname=o.value,n.ssrc=o.ssrc);var s=r.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=s.length>0,n.compound=s.length===0;var c=r.matchPrefix(e,"a=rtcp-mux");return n.mux=c.length>0,n},r.parseMsid=function(e){var n,o=r.matchPrefix(e,"a=msid:");if(o.length===1)return n=o[0].substr(7).split(" "),{stream:n[0],track:n[1]};var s=r.matchPrefix(e,"a=ssrc:").map(function(c){return r.parseSsrcMedia(c)}).filter(function(c){return c.attribute==="msid"});if(s.length>0)return n=s[0].value.split(" "),{stream:n[0],track:n[1]}},r.parseSctpDescription=function(e){var n=r.parseMLine(e),o=r.matchPrefix(e,"a=max-message-size:"),s;o.length>0&&(s=parseInt(o[0].substr(19),10)),isNaN(s)&&(s=65536);var c=r.matchPrefix(e,"a=sctp-port:");if(c.length>0)return{port:parseInt(c[0].substr(12),10),protocol:n.fmt,maxMessageSize:s};var p=r.matchPrefix(e,"a=sctpmap:");if(p.length>0){var a=r.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(a[0],10),protocol:a[1],maxMessageSize:s}}},r.writeSctpDescription=function(e,n){var o=[];return e.protocol!=="DTLS/SCTP"?o=["m="+e.kind+" 9 "+e.protocol+" "+n.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+n.port+`\r
`]:o=["m="+e.kind+" 9 "+e.protocol+" "+n.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+n.port+" "+n.protocol+` 65535\r
`],n.maxMessageSize!==void 0&&o.push("a=max-message-size:"+n.maxMessageSize+`\r
`),o.join("")},r.generateSessionId=function(){return Math.random().toString().substr(2,21)},r.writeSessionBoilerplate=function(e,n,o){var s,c=n!==void 0?n:2;e?s=e:s=r.generateSessionId();var p=o||"thisisadapterortc";return`v=0\r
o=`+p+" "+s+" "+c+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},r.writeMediaSection=function(e,n,o,s){var c=r.writeRtpDescription(e.kind,n);if(c+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),c+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),o==="offer"?"actpass":"active"),c+="a=mid:"+e.mid+`\r
`,e.direction?c+="a="+e.direction+`\r
`:e.rtpSender&&e.rtpReceiver?c+=`a=sendrecv\r
`:e.rtpSender?c+=`a=sendonly\r
`:e.rtpReceiver?c+=`a=recvonly\r
`:c+=`a=inactive\r
`,e.rtpSender){var p="msid:"+s.id+" "+e.rtpSender.track.id+`\r
`;c+="a="+p,c+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+p,e.sendEncodingParameters[0].rtx&&(c+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+p,c+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return c+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+`\r
`,e.rtpSender&&e.sendEncodingParameters[0].rtx&&(c+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+`\r
`),c},r.getDirection=function(e,n){for(var o=r.splitLines(e),s=0;s<o.length;s++)switch(o[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return o[s].substr(2)}return n?r.getDirection(n):"sendrecv"},r.getKind=function(e){var n=r.splitLines(e),o=n[0].split(" ");return o[0].substr(2)},r.isRejected=function(e){return e.split(" ",2)[1]==="0"},r.parseMLine=function(e){var n=r.splitLines(e),o=n[0].substr(2).split(" ");return{kind:o[0],port:parseInt(o[1],10),protocol:o[2],fmt:o.slice(3).join(" ")}},r.parseOLine=function(e){var n=r.matchPrefix(e,"o=")[0],o=n.substr(2).split(" ");return{username:o[0],sessionId:o[1],sessionVersion:parseInt(o[2],10),netType:o[3],addressType:o[4],address:o[5]}},r.isValidSDP=function(e){if(typeof e!="string"||e.length===0)return!1;for(var n=r.splitLines(e),o=0;o<n.length;o++)if(n[o].length<2||n[o].charAt(1)!=="=")return!1;return!0},t.exports=r});function At(t){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type}function be(t,r,e,n,o){var s=m.writeRtpDescription(t.kind,r);if(s+=m.writeIceParameters(t.iceGatherer.getLocalParameters()),s+=m.writeDtlsParameters(t.dtlsTransport.getLocalParameters(),e==="offer"?"actpass":o||"active"),s+="a=mid:"+t.mid+`\r
`,t.rtpSender&&t.rtpReceiver?s+=`a=sendrecv\r
`:t.rtpSender?s+=`a=sendonly\r
`:t.rtpReceiver?s+=`a=recvonly\r
`:s+=`a=inactive\r
`,t.rtpSender){var c=t.rtpSender._initialTrackId||t.rtpSender.track.id;t.rtpSender._initialTrackId=c;var p="msid:"+(n?n.id:"-")+" "+c+`\r
`;s+="a="+p,s+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" "+p,t.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" "+p,s+="a=ssrc-group:FID "+t.sendEncodingParameters[0].ssrc+" "+t.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return s+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" cname:"+m.localCName+`\r
`,t.rtpSender&&t.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" cname:"+m.localCName+`\r
`),s}function Lt(t,r){var e=!1;return t=JSON.parse(JSON.stringify(t)),t.filter(function(n){if(n&&(n.urls||n.url)){var o=n.urls||n.url;n.url&&n.urls;var s=typeof o=="string";return s&&(o=[o]),o=o.filter(function(c){var p=c.indexOf("turn:")===0&&c.indexOf("transport=udp")!==-1&&c.indexOf("turn:[")===-1&&!e;return p?(e=!0,!0):c.indexOf("stun:")===0&&r>=14393&&c.indexOf("?transport=udp")===-1}),delete n.url,n.urls=s?o[0]:o,!!o.length}})}function $(t,r){var e={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(s,c){s=parseInt(s,10);for(var p=0;p<c.length;p++)if(c[p].payloadType===s||c[p].preferredPayloadType===s)return c[p]},o=function(s,c,p,a){var i=n(s.parameters.apt,p),d=n(c.parameters.apt,a);return i&&d&&i.name.toLowerCase()===d.name.toLowerCase()};return t.codecs.forEach(function(s){for(var c=0;c<r.codecs.length;c++){var p=r.codecs[c];if(s.name.toLowerCase()===p.name.toLowerCase()&&s.clockRate===p.clockRate){if(s.name.toLowerCase()==="rtx"&&s.parameters&&p.parameters.apt&&!o(s,p,t.codecs,r.codecs))continue;p=JSON.parse(JSON.stringify(p)),p.numChannels=Math.min(s.numChannels,p.numChannels),e.codecs.push(p),p.rtcpFeedback=p.rtcpFeedback.filter(function(a){for(var i=0;i<s.rtcpFeedback.length;i++)if(s.rtcpFeedback[i].type===a.type&&s.rtcpFeedback[i].parameter===a.parameter)return!0;return!1});break}}}),t.headerExtensions.forEach(function(s){for(var c=0;c<r.headerExtensions.length;c++){var p=r.headerExtensions[c];if(s.uri===p.uri){e.headerExtensions.push(p);break}}}),e}function we(t,r,e){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[r][t].indexOf(e)!==-1}function re(t,r){var e=t.getRemoteCandidates().find(function(n){return r.foundation===n.foundation&&r.ip===n.ip&&r.port===n.port&&r.priority===n.priority&&r.protocol===n.protocol&&r.type===n.type});return e||t.addRemoteCandidate(r),!e}function _(t,r){var e=new Error(r);return e.name=t,e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[t],e}var jt=function(t,r){function e(a,i){i.addTrack(a),i.dispatchEvent(new t.MediaStreamTrackEvent("addtrack",{track:a}))}function n(a,i){i.removeTrack(a),i.dispatchEvent(new t.MediaStreamTrackEvent("removetrack",{track:a}))}function o(a,i,d,u){var l=new Event("track");l.track=i,l.receiver=d,l.transceiver={receiver:d},l.streams=u,t.setTimeout(function(){a._dispatchEvent("track",l)})}var s=function(a){var i=this,d=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(l){i[l]=d[l].bind(d)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",a=JSON.parse(JSON.stringify(a||{})),this.usingBundle=a.bundlePolicy==="max-bundle",a.rtcpMuxPolicy==="negotiate")throw _("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(a.rtcpMuxPolicy||(a.rtcpMuxPolicy="require"),a.iceTransportPolicy){case"all":case"relay":break;default:a.iceTransportPolicy="all";break}switch(a.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:a.bundlePolicy="balanced";break}if(a.iceServers=Lt(a.iceServers||[],r),this._iceGatherers=[],a.iceCandidatePoolSize)for(var u=a.iceCandidatePoolSize;u>0;u--)this._iceGatherers.push(new t.RTCIceGatherer({iceServers:a.iceServers,gatherPolicy:a.iceTransportPolicy}));else a.iceCandidatePoolSize=0;this._config=a,this.transceivers=[],this._sdpSessionId=m.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(s.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(s.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),s.prototype.onicecandidate=null,s.prototype.onaddstream=null,s.prototype.ontrack=null,s.prototype.onremovestream=null,s.prototype.onsignalingstatechange=null,s.prototype.oniceconnectionstatechange=null,s.prototype.onconnectionstatechange=null,s.prototype.onicegatheringstatechange=null,s.prototype.onnegotiationneeded=null,s.prototype.ondatachannel=null,s.prototype._dispatchEvent=function(a,i){this._isClosed||(this.dispatchEvent(i),typeof this["on"+a]=="function"&&this["on"+a](i))},s.prototype._emitGatheringStateChange=function(){var a=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",a)},s.prototype.getConfiguration=function(){return this._config},s.prototype.getLocalStreams=function(){return this.localStreams},s.prototype.getRemoteStreams=function(){return this.remoteStreams},s.prototype._createTransceiver=function(a,i){var d=this.transceivers.length>0,u={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:a,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&d)u.iceTransport=this.transceivers[0].iceTransport,u.dtlsTransport=this.transceivers[0].dtlsTransport;else{var l=this._createIceAndDtlsTransports();u.iceTransport=l.iceTransport,u.dtlsTransport=l.dtlsTransport}return i||this.transceivers.push(u),u},s.prototype.addTrack=function(a,i){if(this._isClosed)throw _("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var d=this.transceivers.find(function(h){return h.track===a});if(d)throw _("InvalidAccessError","Track already exists.");for(var u,l=0;l<this.transceivers.length;l++)!this.transceivers[l].track&&this.transceivers[l].kind===a.kind&&(u=this.transceivers[l]);return u||(u=this._createTransceiver(a.kind)),this._maybeFireNegotiationNeeded(),this.localStreams.indexOf(i)===-1&&this.localStreams.push(i),u.track=a,u.stream=i,u.rtpSender=new t.RTCRtpSender(a,u.dtlsTransport),u.rtpSender},s.prototype.addStream=function(a){var i=this;if(r>=15025)a.getTracks().forEach(function(u){i.addTrack(u,a)});else{var d=a.clone();a.getTracks().forEach(function(u,l){var h=d.getTracks()[l];u.addEventListener("enabled",function(f){h.enabled=f.enabled})}),d.getTracks().forEach(function(u){i.addTrack(u,d)})}},s.prototype.removeTrack=function(a){if(this._isClosed)throw _("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(a instanceof t.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find(function(l){return l.rtpSender===a});if(!i)throw _("InvalidAccessError","Sender was not created by this connection.");var d=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null;var u=this.transceivers.map(function(l){return l.stream});u.indexOf(d)===-1&&this.localStreams.indexOf(d)>-1&&this.localStreams.splice(this.localStreams.indexOf(d),1),this._maybeFireNegotiationNeeded()},s.prototype.removeStream=function(a){var i=this;a.getTracks().forEach(function(d){var u=i.getSenders().find(function(l){return l.track===d});u&&i.removeTrack(u)})},s.prototype.getSenders=function(){return this.transceivers.filter(function(a){return!!a.rtpSender}).map(function(a){return a.rtpSender})},s.prototype.getReceivers=function(){return this.transceivers.filter(function(a){return!!a.rtpReceiver}).map(function(a){return a.rtpReceiver})},s.prototype._createIceGatherer=function(a,i){var d=this;if(i&&a>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var u=new t.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(u,"state",{value:"new",writable:!0}),this.transceivers[a].bufferedCandidateEvents=[],this.transceivers[a].bufferCandidates=function(l){var h=!l.candidate||Object.keys(l.candidate).length===0;u.state=h?"completed":"gathering",d.transceivers[a].bufferedCandidateEvents!==null&&d.transceivers[a].bufferedCandidateEvents.push(l)},u.addEventListener("localcandidate",this.transceivers[a].bufferCandidates),u},s.prototype._gather=function(a,i){var d=this,u=this.transceivers[i].iceGatherer;if(!u.onlocalcandidate){var l=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,u.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),u.onlocalcandidate=function(h){if(!(d.usingBundle&&i>0)){var f=new Event("icecandidate");f.candidate={sdpMid:a,sdpMLineIndex:i};var y=h.candidate,T=!y||Object.keys(y).length===0;if(T)(u.state==="new"||u.state==="gathering")&&(u.state="completed");else{u.state==="new"&&(u.state="gathering"),y.component=1,y.ufrag=u.getLocalParameters().usernameFragment;var v=m.writeCandidate(y);f.candidate=Object.assign(f.candidate,m.parseCandidate(v)),f.candidate.candidate=v,f.candidate.toJSON=function(){return{candidate:f.candidate.candidate,sdpMid:f.candidate.sdpMid,sdpMLineIndex:f.candidate.sdpMLineIndex,usernameFragment:f.candidate.usernameFragment}}}var g=m.getMediaSections(d._localDescription.sdp);T?g[f.candidate.sdpMLineIndex]+=`a=end-of-candidates\r
`:g[f.candidate.sdpMLineIndex]+="a="+f.candidate.candidate+`\r
`,d._localDescription.sdp=m.getDescription(d._localDescription.sdp)+g.join("");var E=d.transceivers.every(function(R){return R.iceGatherer&&R.iceGatherer.state==="completed"});d.iceGatheringState!=="gathering"&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),T||d._dispatchEvent("icecandidate",f),E&&(d._dispatchEvent("icecandidate",new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange())}},t.setTimeout(function(){l.forEach(function(h){u.onlocalcandidate(h)})},0)}},s.prototype._createIceAndDtlsTransports=function(){var a=this,i=new t.RTCIceTransport(null);i.onicestatechange=function(){a._updateIceConnectionState(),a._updateConnectionState()};var d=new t.RTCDtlsTransport(i);return d.ondtlsstatechange=function(){a._updateConnectionState()},d.onerror=function(){Object.defineProperty(d,"state",{value:"failed",writable:!0}),a._updateConnectionState()},{iceTransport:i,dtlsTransport:d}},s.prototype._disposeIceAndDtlsTransports=function(a){var i=this.transceivers[a].iceGatherer;i&&(delete i.onlocalcandidate,delete this.transceivers[a].iceGatherer);var d=this.transceivers[a].iceTransport;d&&(delete d.onicestatechange,delete this.transceivers[a].iceTransport);var u=this.transceivers[a].dtlsTransport;u&&(delete u.ondtlsstatechange,delete u.onerror,delete this.transceivers[a].dtlsTransport)},s.prototype._transceive=function(a,i,d){var u=$(a.localCapabilities,a.remoteCapabilities);i&&a.rtpSender&&(u.encodings=a.sendEncodingParameters,u.rtcp={cname:m.localCName,compound:a.rtcpParameters.compound},a.recvEncodingParameters.length&&(u.rtcp.ssrc=a.recvEncodingParameters[0].ssrc),a.rtpSender.send(u)),d&&a.rtpReceiver&&u.codecs.length>0&&(a.kind==="video"&&a.recvEncodingParameters&&r<15019&&a.recvEncodingParameters.forEach(function(l){delete l.rtx}),a.recvEncodingParameters.length?u.encodings=a.recvEncodingParameters:u.encodings=[{}],u.rtcp={compound:a.rtcpParameters.compound},a.rtcpParameters.cname&&(u.rtcp.cname=a.rtcpParameters.cname),a.sendEncodingParameters.length&&(u.rtcp.ssrc=a.sendEncodingParameters[0].ssrc),a.rtpReceiver.receive(u))},s.prototype.setLocalDescription=function(a){var i=this;if(["offer","answer"].indexOf(a.type)===-1)return Promise.reject(_("TypeError",'Unsupported type "'+a.type+'"'));if(!we("setLocalDescription",a.type,i.signalingState)||i._isClosed)return Promise.reject(_("InvalidStateError","Can not set local "+a.type+" in state "+i.signalingState));var d,u;if(a.type==="offer")d=m.splitSections(a.sdp),u=d.shift(),d.forEach(function(h,f){var y=m.parseRtpParameters(h);i.transceivers[f].localCapabilities=y}),i.transceivers.forEach(function(h,f){i._gather(h.mid,f)});else if(a.type==="answer"){d=m.splitSections(i._remoteDescription.sdp),u=d.shift();var l=m.matchPrefix(u,"a=ice-lite").length>0;d.forEach(function(h,f){var y=i.transceivers[f],T=y.iceGatherer,v=y.iceTransport,g=y.dtlsTransport,E=y.localCapabilities,R=y.remoteCapabilities,S=m.isRejected(h)&&m.matchPrefix(h,"a=bundle-only").length===0;if(!S&&!y.rejected){var k=m.getIceParameters(h,u),b=m.getDtlsParameters(h,u);l&&(b.role="server"),(!i.usingBundle||f===0)&&(i._gather(y.mid,f),v.state==="new"&&v.start(T,k,l?"controlling":"controlled"),g.state==="new"&&g.start(b));var P=$(E,R);i._transceive(y,P.codecs.length>0,!1)}})}return i._localDescription={type:a.type,sdp:a.sdp},a.type==="offer"?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},s.prototype.setRemoteDescription=function(a){var i=this;if(["offer","answer"].indexOf(a.type)===-1)return Promise.reject(_("TypeError",'Unsupported type "'+a.type+'"'));if(!we("setRemoteDescription",a.type,i.signalingState)||i._isClosed)return Promise.reject(_("InvalidStateError","Can not set remote "+a.type+" in state "+i.signalingState));var d={};i.remoteStreams.forEach(function(v){d[v.id]=v});var u=[],l=m.splitSections(a.sdp),h=l.shift(),f=m.matchPrefix(h,"a=ice-lite").length>0,y=m.matchPrefix(h,"a=group:BUNDLE ").length>0;i.usingBundle=y;var T=m.matchPrefix(h,"a=ice-options:")[0];return T?i.canTrickleIceCandidates=T.substr(14).split(" ").indexOf("trickle")>=0:i.canTrickleIceCandidates=!1,l.forEach(function(v,g){var E=m.splitLines(v),R=m.getKind(v),S=m.isRejected(v)&&m.matchPrefix(v,"a=bundle-only").length===0,k=E[0].substr(2).split(" ")[2],b=m.getDirection(v,h),P=m.parseMsid(v),fe=m.getMid(v)||m.generateIdentifier();if(S||R==="application"&&(k==="DTLS/SCTP"||k==="UDP/DTLS/SCTP")){i.transceivers[g]={mid:fe,kind:R,protocol:k,rejected:!0};return}!S&&i.transceivers[g]&&i.transceivers[g].rejected&&(i.transceivers[g]=i._createTransceiver(R,!0));var C,me,U,Y,D,Z,Q,B,I,ve=m.parseRtpParameters(v),ge,ee;S||(ge=m.getIceParameters(v,h),ee=m.getDtlsParameters(v,h),ee.role="client"),Q=m.parseRtpEncodingParameters(v);var ye=m.parseRtcpParameters(v),Ce=m.matchPrefix(v,"a=end-of-candidates",h).length>0,L=m.matchPrefix(v,"a=candidate:").map(function(w){return m.parseCandidate(w)}).filter(function(w){return w.component===1});if((a.type==="offer"||a.type==="answer")&&!S&&y&&g>0&&i.transceivers[g]&&(i._disposeIceAndDtlsTransports(g),i.transceivers[g].iceGatherer=i.transceivers[0].iceGatherer,i.transceivers[g].iceTransport=i.transceivers[0].iceTransport,i.transceivers[g].dtlsTransport=i.transceivers[0].dtlsTransport,i.transceivers[g].rtpSender&&i.transceivers[g].rtpSender.setTransport(i.transceivers[0].dtlsTransport),i.transceivers[g].rtpReceiver&&i.transceivers[g].rtpReceiver.setTransport(i.transceivers[0].dtlsTransport)),a.type==="offer"&&!S){C=i.transceivers[g]||i._createTransceiver(R),C.mid=fe,C.iceGatherer||(C.iceGatherer=i._createIceGatherer(g,y)),L.length&&C.iceTransport.state==="new"&&(Ce&&(!y||g===0)?C.iceTransport.setRemoteCandidates(L):L.forEach(function(w){re(C.iceTransport,w)})),B=t.RTCRtpReceiver.getCapabilities(R),r<15019&&(B.codecs=B.codecs.filter(function(w){return w.name!=="rtx"})),Z=C.sendEncodingParameters||[{ssrc:(2*g+2)*1001}];var te=!1;if(b==="sendrecv"||b==="sendonly"){if(te=!C.rtpReceiver,D=C.rtpReceiver||new t.RTCRtpReceiver(C.dtlsTransport,R),te){var j;I=D.track,P&&P.stream==="-"||(P?(d[P.stream]||(d[P.stream]=new t.MediaStream,Object.defineProperty(d[P.stream],"id",{get:function(){return P.stream}})),Object.defineProperty(I,"id",{get:function(){return P.track}}),j=d[P.stream]):(d.default||(d.default=new t.MediaStream),j=d.default)),j&&(e(I,j),C.associatedRemoteMediaStreams.push(j)),u.push([I,D,j])}}else C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach(function(w){var Te=w.getTracks().find(function(St){return St.id===C.rtpReceiver.track.id});Te&&n(Te,w)}),C.associatedRemoteMediaStreams=[]);C.localCapabilities=B,C.remoteCapabilities=ve,C.rtpReceiver=D,C.rtcpParameters=ye,C.sendEncodingParameters=Z,C.recvEncodingParameters=Q,i._transceive(i.transceivers[g],!1,te)}else if(a.type==="answer"&&!S){C=i.transceivers[g],me=C.iceGatherer,U=C.iceTransport,Y=C.dtlsTransport,D=C.rtpReceiver,Z=C.sendEncodingParameters,B=C.localCapabilities,i.transceivers[g].recvEncodingParameters=Q,i.transceivers[g].remoteCapabilities=ve,i.transceivers[g].rtcpParameters=ye,L.length&&U.state==="new"&&((f||Ce)&&(!y||g===0)?U.setRemoteCandidates(L):L.forEach(function(w){re(C.iceTransport,w)})),(!y||g===0)&&(U.state==="new"&&U.start(me,ge,"controlling"),Y.state==="new"&&Y.start(ee));var Ct=$(C.localCapabilities,C.remoteCapabilities),Tt=Ct.codecs.filter(function(w){return w.name.toLowerCase()==="rtx"}).length;!Tt&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,i._transceive(C,b==="sendrecv"||b==="recvonly",b==="sendrecv"||b==="sendonly"),D&&(b==="sendrecv"||b==="sendonly")?(I=D.track,P?(d[P.stream]||(d[P.stream]=new t.MediaStream),e(I,d[P.stream]),u.push([I,D,d[P.stream]])):(d.default||(d.default=new t.MediaStream),e(I,d.default),u.push([I,D,d.default]))):delete C.rtpReceiver}}),i._dtlsRole===void 0&&(i._dtlsRole=a.type==="offer"?"active":"passive"),i._remoteDescription={type:a.type,sdp:a.sdp},a.type==="offer"?i._updateSignalingState("have-remote-offer"):i._updateSignalingState("stable"),Object.keys(d).forEach(function(v){var g=d[v];if(g.getTracks().length){if(i.remoteStreams.indexOf(g)===-1){i.remoteStreams.push(g);var E=new Event("addstream");E.stream=g,t.setTimeout(function(){i._dispatchEvent("addstream",E)})}u.forEach(function(R){var S=R[0],k=R[1];g.id===R[2].id&&o(i,S,k,[g])})}}),u.forEach(function(v){v[2]||o(i,v[0],v[1],[])}),t.setTimeout(function(){i&&i.transceivers&&i.transceivers.forEach(function(v){v.iceTransport&&v.iceTransport.state==="new"&&v.iceTransport.getRemoteCandidates().length>0&&v.iceTransport.addRemoteCandidate({})})},4e3),Promise.resolve()},s.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&a.iceTransport.stop(),a.dtlsTransport&&a.dtlsTransport.stop(),a.rtpSender&&a.rtpSender.stop(),a.rtpReceiver&&a.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},s.prototype._updateSignalingState=function(a){this.signalingState=a;var i=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",i)},s.prototype._maybeFireNegotiationNeeded=function(){var a=this;this.signalingState!=="stable"||this.needNegotiation===!0||(this.needNegotiation=!0,t.setTimeout(function(){if(a.needNegotiation){a.needNegotiation=!1;var i=new Event("negotiationneeded");a._dispatchEvent("negotiationneeded",i)}},0))},s.prototype._updateIceConnectionState=function(){var a,i={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&!u.rejected&&i[u.iceTransport.state]++}),a="new",i.failed>0?a="failed":i.checking>0?a="checking":i.disconnected>0?a="disconnected":i.new>0?a="new":i.connected>0?a="connected":i.completed>0&&(a="completed"),a!==this.iceConnectionState){this.iceConnectionState=a;var d=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",d)}},s.prototype._updateConnectionState=function(){var a,i={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&u.dtlsTransport&&!u.rejected&&(i[u.iceTransport.state]++,i[u.dtlsTransport.state]++)}),i.connected+=i.completed,a="new",i.failed>0?a="failed":i.connecting>0?a="connecting":i.disconnected>0?a="disconnected":i.new>0?a="new":i.connected>0&&(a="connected"),a!==this.connectionState){this.connectionState=a;var d=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",d)}},s.prototype.createOffer=function(){var a=this;if(a._isClosed)return Promise.reject(_("InvalidStateError","Can not call createOffer after close"));var i=a.transceivers.filter(function(f){return f.kind==="audio"}).length,d=a.transceivers.filter(function(f){return f.kind==="video"}).length,u=arguments[0];if(u){if(u.mandatory||u.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");u.offerToReceiveAudio!==void 0&&(u.offerToReceiveAudio===!0?i=1:u.offerToReceiveAudio===!1?i=0:i=u.offerToReceiveAudio),u.offerToReceiveVideo!==void 0&&(u.offerToReceiveVideo===!0?d=1:u.offerToReceiveVideo===!1?d=0:d=u.offerToReceiveVideo)}for(a.transceivers.forEach(function(f){f.kind==="audio"?(i--,i<0&&(f.wantReceive=!1)):f.kind==="video"&&(d--,d<0&&(f.wantReceive=!1))});i>0||d>0;)i>0&&(a._createTransceiver("audio"),i--),d>0&&(a._createTransceiver("video"),d--);var l=m.writeSessionBoilerplate(a._sdpSessionId,a._sdpSessionVersion++);a.transceivers.forEach(function(f,y){var T=f.track,v=f.kind,g=f.mid||m.generateIdentifier();f.mid=g,f.iceGatherer||(f.iceGatherer=a._createIceGatherer(y,a.usingBundle));var E=t.RTCRtpSender.getCapabilities(v);r<15019&&(E.codecs=E.codecs.filter(function(S){return S.name!=="rtx"})),E.codecs.forEach(function(S){S.name==="H264"&&S.parameters["level-asymmetry-allowed"]===void 0&&(S.parameters["level-asymmetry-allowed"]="1"),f.remoteCapabilities&&f.remoteCapabilities.codecs&&f.remoteCapabilities.codecs.forEach(function(k){S.name.toLowerCase()===k.name.toLowerCase()&&S.clockRate===k.clockRate&&(S.preferredPayloadType=k.payloadType)})}),E.headerExtensions.forEach(function(S){var k=f.remoteCapabilities&&f.remoteCapabilities.headerExtensions||[];k.forEach(function(b){S.uri===b.uri&&(S.id=b.id)})});var R=f.sendEncodingParameters||[{ssrc:(2*y+1)*1001}];T&&r>=15019&&v==="video"&&!R[0].rtx&&(R[0].rtx={ssrc:R[0].ssrc+1}),f.wantReceive&&(f.rtpReceiver=new t.RTCRtpReceiver(f.dtlsTransport,v)),f.localCapabilities=E,f.sendEncodingParameters=R}),a._config.bundlePolicy!=="max-compat"&&(l+="a=group:BUNDLE "+a.transceivers.map(function(f){return f.mid}).join(" ")+`\r
`),l+=`a=ice-options:trickle\r
`,a.transceivers.forEach(function(f,y){l+=be(f,f.localCapabilities,"offer",f.stream,a._dtlsRole),l+=`a=rtcp-rsize\r
`,f.iceGatherer&&a.iceGatheringState!=="new"&&(y===0||!a.usingBundle)&&(f.iceGatherer.getLocalCandidates().forEach(function(T){T.component=1,l+="a="+m.writeCandidate(T)+`\r
`}),f.iceGatherer.state==="completed"&&(l+=`a=end-of-candidates\r
`))});var h=new t.RTCSessionDescription({type:"offer",sdp:l});return Promise.resolve(h)},s.prototype.createAnswer=function(){var a=this;if(a._isClosed)return Promise.reject(_("InvalidStateError","Can not call createAnswer after close"));if(!(a.signalingState==="have-remote-offer"||a.signalingState==="have-local-pranswer"))return Promise.reject(_("InvalidStateError","Can not call createAnswer in signalingState "+a.signalingState));var i=m.writeSessionBoilerplate(a._sdpSessionId,a._sdpSessionVersion++);a.usingBundle&&(i+="a=group:BUNDLE "+a.transceivers.map(function(l){return l.mid}).join(" ")+`\r
`),i+=`a=ice-options:trickle\r
`;var d=m.getMediaSections(a._remoteDescription.sdp).length;a.transceivers.forEach(function(l,h){if(!(h+1>d)){if(l.rejected){l.kind==="application"?l.protocol==="DTLS/SCTP"?i+=`m=application 0 DTLS/SCTP 5000\r
`:i+="m=application 0 "+l.protocol+` webrtc-datachannel\r
`:l.kind==="audio"?i+=`m=audio 0 UDP/TLS/RTP/SAVPF 0\r
a=rtpmap:0 PCMU/8000\r
`:l.kind==="video"&&(i+=`m=video 0 UDP/TLS/RTP/SAVPF 120\r
a=rtpmap:120 VP8/90000\r
`),i+=`c=IN IP4 0.0.0.0\r
a=inactive\r
a=mid:`+l.mid+`\r
`;return}if(l.stream){var f;l.kind==="audio"?f=l.stream.getAudioTracks()[0]:l.kind==="video"&&(f=l.stream.getVideoTracks()[0]),f&&r>=15019&&l.kind==="video"&&!l.sendEncodingParameters[0].rtx&&(l.sendEncodingParameters[0].rtx={ssrc:l.sendEncodingParameters[0].ssrc+1})}var y=$(l.localCapabilities,l.remoteCapabilities),T=y.codecs.filter(function(v){return v.name.toLowerCase()==="rtx"}).length;!T&&l.sendEncodingParameters[0].rtx&&delete l.sendEncodingParameters[0].rtx,i+=be(l,y,"answer",l.stream,a._dtlsRole),l.rtcpParameters&&l.rtcpParameters.reducedSize&&(i+=`a=rtcp-rsize\r
`)}});var u=new t.RTCSessionDescription({type:"answer",sdp:i});return Promise.resolve(u)},s.prototype.addIceCandidate=function(a){var i=this,d;return a&&!(a.sdpMLineIndex!==void 0||a.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(u,l){if(i._remoteDescription)if(!a||a.candidate==="")for(var h=0;h<i.transceivers.length&&!(!i.transceivers[h].rejected&&(i.transceivers[h].iceTransport.addRemoteCandidate({}),d=m.getMediaSections(i._remoteDescription.sdp),d[h]+=`a=end-of-candidates\r
`,i._remoteDescription.sdp=m.getDescription(i._remoteDescription.sdp)+d.join(""),i.usingBundle));h++);else{var f=a.sdpMLineIndex;if(a.sdpMid){for(var y=0;y<i.transceivers.length;y++)if(i.transceivers[y].mid===a.sdpMid){f=y;break}}var T=i.transceivers[f];if(T){if(T.rejected)return u();var v=Object.keys(a.candidate).length>0?m.parseCandidate(a.candidate):{};if(v.protocol==="tcp"&&(v.port===0||v.port===9)||v.component&&v.component!==1)return u();if((f===0||f>0&&T.iceTransport!==i.transceivers[0].iceTransport)&&!re(T.iceTransport,v))return l(_("OperationError","Can not add ICE candidate"));var g=a.candidate.trim();g.indexOf("a=")===0&&(g=g.substr(2)),d=m.getMediaSections(i._remoteDescription.sdp),d[f]+="a="+(v.type?g:"end-of-candidates")+`\r
`,i._remoteDescription.sdp=m.getDescription(i._remoteDescription.sdp)+d.join("")}else return l(_("OperationError","Can not add ICE candidate"))}else return l(_("InvalidStateError","Can not add ICE candidate without a remote description"));u()})},s.prototype.getStats=function(a){if(a&&a instanceof t.MediaStreamTrack){var i=null;if(this.transceivers.forEach(function(u){u.rtpSender&&u.rtpSender.track===a?i=u.rtpSender:u.rtpReceiver&&u.rtpReceiver.track===a&&(i=u.rtpReceiver)}),!i)throw _("InvalidAccessError","Invalid selector.");return i.getStats()}var d=[];return this.transceivers.forEach(function(u){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(l){u[l]&&d.push(u[l].getStats())})}),Promise.all(d).then(function(u){var l=new Map;return u.forEach(function(h){h.forEach(function(f){l.set(f.id,f)})}),l})};var c=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];c.forEach(function(a){var i=t[a];if(i&&i.prototype&&i.prototype.getStats){var d=i.prototype.getStats;i.prototype.getStats=function(){return d.apply(this).then(function(u){var l=new Map;return Object.keys(u).forEach(function(h){u[h].type=At(u[h]),l.set(h,u[h])}),l})}}});var p=["createOffer","createAnswer"];return p.forEach(function(a){var i=s.prototype[a];s.prototype[a]=function(){var d=arguments;return typeof d[0]=="function"||typeof d[1]=="function"?i.apply(this,[arguments[2]]).then(function(u){typeof d[0]=="function"&&d[0].apply(null,[u])},function(u){typeof d[1]=="function"&&d[1].apply(null,[u])}):i.apply(this,arguments)}}),p=["setLocalDescription","setRemoteDescription","addIceCandidate"],p.forEach(function(a){var i=s.prototype[a];s.prototype[a]=function(){var d=arguments;return typeof d[1]=="function"||typeof d[2]=="function"?i.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)},function(u){typeof d[2]=="function"&&d[2].apply(null,[u])}):i.apply(this,arguments)}}),["getStats"].forEach(function(a){var i=s.prototype[a];s.prototype[a]=function(){var d=arguments;return typeof d[1]=="function"?i.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)}):i.apply(this,arguments)}}),s};function Be(t){const r=t&&t.navigator,e=function(o){return{name:{PermissionDeniedError:"NotAllowedError"}[o.name]||o.name,message:o.message,constraint:o.constraint,toString(){return this.name}}},n=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(o){return n(o).catch(s=>Promise.reject(e(s)))}}function ze(t){"getDisplayMedia"in t.navigator&&t.navigator.mediaDevices&&(t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||(t.navigator.mediaDevices.getDisplayMedia=t.navigator.getDisplayMedia.bind(t.navigator)))}function oe(t,r){if(t.RTCIceGatherer&&(t.RTCIceCandidate||(t.RTCIceCandidate=function(n){return n}),t.RTCSessionDescription||(t.RTCSessionDescription=function(n){return n}),r.version<15025)){const n=Object.getOwnPropertyDescriptor(t.MediaStreamTrack.prototype,"enabled");Object.defineProperty(t.MediaStreamTrack.prototype,"enabled",{set(o){n.set.call(this,o);const s=new Event("enabled");s.enabled=o,this.dispatchEvent(s)}})}t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)&&Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=new t.RTCDtmfSender(this):this.track.kind==="video"&&(this._dtmf=null)),this._dtmf}}),t.RTCDtmfSender&&!t.RTCDTMFSender&&(t.RTCDTMFSender=t.RTCDtmfSender);const e=jt(t,r.version);t.RTCPeerConnection=function(n){return n&&n.iceServers&&(n.iceServers=xt(n.iceServers,r.version),n.iceServers),new e(n)},t.RTCPeerConnection.prototype=e.prototype}function We(t){t.RTCRtpSender&&!("replaceTrack"in t.RTCRtpSender.prototype)&&(t.RTCRtpSender.prototype.replaceTrack=t.RTCRtpSender.prototype.setTrack)}var ke=Object.freeze({__proto__:null,shimPeerConnection:oe,shimReplaceTrack:We,shimGetUserMedia:Be,shimGetDisplayMedia:ze});function Je(t,r){const e=t&&t.navigator,n=t&&t.MediaStreamTrack;if(e.getUserMedia=function(o,s,c){e.mediaDevices.getUserMedia(o).then(s,c)},!(r.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){const o=function(c,p,a){p in c&&!(a in c)&&(c[a]=c[p],delete c[p])},s=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if(e.mediaDevices.getUserMedia=function(c){return typeof c=="object"&&typeof c.audio=="object"&&(c=JSON.parse(JSON.stringify(c)),o(c.audio,"autoGainControl","mozAutoGainControl"),o(c.audio,"noiseSuppression","mozNoiseSuppression")),s(c)},n&&n.prototype.getSettings){const c=n.prototype.getSettings;n.prototype.getSettings=function(){const p=c.apply(this,arguments);return o(p,"mozAutoGainControl","autoGainControl"),o(p,"mozNoiseSuppression","noiseSuppression"),p}}if(n&&n.prototype.applyConstraints){const c=n.prototype.applyConstraints;n.prototype.applyConstraints=function(p){return this.kind==="audio"&&typeof p=="object"&&(p=JSON.parse(JSON.stringify(p)),o(p,"autoGainControl","mozAutoGainControl"),o(p,"noiseSuppression","mozNoiseSuppression")),c.apply(this,[p])}}}}function Nt(t,r){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(e){if(!(e&&e.video)){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return e.video===!0?e.video={mediaSource:r}:e.video.mediaSource=r,t.navigator.mediaDevices.getUserMedia(e)})}function $e(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function se(t,r){if(typeof t!="object"||!(t.RTCPeerConnection||t.mozRTCPeerConnection))return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),r.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(o){const s=t.RTCPeerConnection.prototype[o],c={[o](){return arguments[0]=new(o==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};t.RTCPeerConnection.prototype[o]=c[o]});const e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[o,s,c]=arguments;return n.apply(this,[o||null]).then(p=>{if(r.version<53&&!s)try{p.forEach(a=>{a.type=e[a.type]||a.type})}catch(a){if(a.name!=="TypeError")throw a;p.forEach((i,d)=>{p.set(d,Object.assign({},i,{type:e[i.type]||i.type}))})}return p}).then(s,c)}}function He(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender)||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const r=t.RTCPeerConnection.prototype.getSenders;r&&(t.RTCPeerConnection.prototype.getSenders=function(){const n=r.apply(this,[]);return n.forEach(o=>o._pc=this),n});const e=t.RTCPeerConnection.prototype.addTrack;e&&(t.RTCPeerConnection.prototype.addTrack=function(){const n=e.apply(this,arguments);return n._pc=this,n}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Ke(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender)||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const r=t.RTCPeerConnection.prototype.getReceivers;r&&(t.RTCPeerConnection.prototype.getReceivers=function(){const e=r.apply(this,[]);return e.forEach(n=>n._pc=this),e}),F(t,"track",e=>(e.receiver._pc=e.srcElement,e)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Xe(t){!t.RTCPeerConnection||"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(r){this.getSenders().forEach(e=>{e.track&&r.getTracks().includes(e.track)&&this.removeTrack(e)})})}function qe(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function Ye(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const r=t.RTCPeerConnection.prototype.addTransceiver;r&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],n=e&&"sendEncodings"in e;n&&e.sendEncodings.forEach(s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const o=r.apply(this,arguments);if(n){const{sender:s}=o,c=s.getParameters();(!("encodings"in c)||c.encodings.length===1&&Object.keys(c.encodings[0]).length===0)&&(c.encodings=e.sendEncodings,s.sendEncodings=e.sendEncodings,this.setParametersPromises.push(s.setParameters(c).then(()=>{delete s.sendEncodings}).catch(()=>{delete s.sendEncodings})))}return o})}function Ze(t){if(!(typeof t=="object"&&t.RTCRtpSender))return;const r=t.RTCRtpSender.prototype.getParameters;r&&(t.RTCRtpSender.prototype.getParameters=function(){const e=r.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Qe(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const r=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>r.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):r.apply(this,arguments)}}function et(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const r=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>r.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):r.apply(this,arguments)}}var De=Object.freeze({__proto__:null,shimOnTrack:$e,shimPeerConnection:se,shimSenderGetStats:He,shimReceiverGetStats:Ke,shimRemoveStream:Xe,shimRTCDataChannel:qe,shimAddTransceiver:Ye,shimGetParameters:Ze,shimCreateOffer:Qe,shimCreateAnswer:et,shimGetUserMedia:Je,shimGetDisplayMedia:Nt});function tt(t){if(!(typeof t!="object"||!t.RTCPeerConnection)){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(n=>r.call(this,n,e)),e.getVideoTracks().forEach(n=>r.call(this,n,e))},t.RTCPeerConnection.prototype.addTrack=function(e,...n){return n&&n.forEach(o=>{this._localStreams?this._localStreams.includes(o)||this._localStreams.push(o):this._localStreams=[o]}),r.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(r){this._localStreams||(this._localStreams=[]);const e=this._localStreams.indexOf(r);if(e===-1)return;this._localStreams.splice(e,1);const n=r.getTracks();this.getSenders().forEach(o=>{n.includes(o.track)&&this.removeTrack(o)})})}}function rt(t){if(!(typeof t!="object"||!t.RTCPeerConnection)&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=n=>{n.streams.forEach(o=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(o))return;this._remoteStreams.push(o);const s=new Event("addstream");s.stream=o,this.dispatchEvent(s)})})}});const r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(o=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(o)>=0)return;e._remoteStreams.push(o);const s=new Event("addstream");s.stream=o,e.dispatchEvent(s)})}),r.apply(e,arguments)}}}function nt(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const r=t.RTCPeerConnection.prototype,e=r.createOffer,n=r.createAnswer,o=r.setLocalDescription,s=r.setRemoteDescription,c=r.addIceCandidate;r.createOffer=function(a,i){const d=arguments.length>=2?arguments[2]:arguments[0],u=e.apply(this,[d]);return i?(u.then(a,i),Promise.resolve()):u},r.createAnswer=function(a,i){const d=arguments.length>=2?arguments[2]:arguments[0],u=n.apply(this,[d]);return i?(u.then(a,i),Promise.resolve()):u};let p=function(a,i,d){const u=o.apply(this,[a]);return d?(u.then(i,d),Promise.resolve()):u};r.setLocalDescription=p,p=function(a,i,d){const u=s.apply(this,[a]);return d?(u.then(i,d),Promise.resolve()):u},r.setRemoteDescription=p,p=function(a,i,d){const u=c.apply(this,[a]);return d?(u.then(i,d),Promise.resolve()):u},r.addIceCandidate=p}function it(t){const r=t&&t.navigator;if(r.mediaDevices&&r.mediaDevices.getUserMedia){const e=r.mediaDevices,n=e.getUserMedia.bind(e);r.mediaDevices.getUserMedia=o=>n(at(o))}!r.getUserMedia&&r.mediaDevices&&r.mediaDevices.getUserMedia&&(r.getUserMedia=function(e,n,o){r.mediaDevices.getUserMedia(e).then(n,o)}.bind(r))}function at(t){return t&&t.video!==void 0?Object.assign({},t,{video:xe(t.video)}):t}function ot(t){if(!t.RTCPeerConnection)return;const r=t.RTCPeerConnection;t.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const o=[];for(let s=0;s<e.iceServers.length;s++){let c=e.iceServers[s];!c.hasOwnProperty("urls")&&c.hasOwnProperty("url")?(c=JSON.parse(JSON.stringify(c)),c.urls=c.url,delete c.url,o.push(c)):o.push(e.iceServers[s])}e.iceServers=o}return new r(e,n)},t.RTCPeerConnection.prototype=r.prototype,"generateCertificate"in r&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get(){return r.generateCertificate}})}function st(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ct(t){const r=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(e){if(e){typeof e.offerToReceiveAudio<"u"&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const n=this.getTransceivers().find(s=>s.receiver.track.kind==="audio");e.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):e.offerToReceiveAudio===!0&&!n&&this.addTransceiver("audio"),typeof e.offerToReceiveVideo<"u"&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const o=this.getTransceivers().find(s=>s.receiver.track.kind==="video");e.offerToReceiveVideo===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):e.offerToReceiveVideo===!0&&!o&&this.addTransceiver("video")}return r.apply(this,arguments)}}function dt(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var Ie=Object.freeze({__proto__:null,shimLocalStreamsAPI:tt,shimRemoteStreamsAPI:rt,shimCallbacksAPI:nt,shimGetUserMedia:it,shimConstraints:at,shimRTCIceServerUrls:ot,shimTrackEventTransceiver:st,shimCreateOfferLegacy:ct,shimAudioContext:dt});function K(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const r=t.RTCIceCandidate;t.RTCIceCandidate=function(e){if(typeof e=="object"&&e.candidate&&e.candidate.indexOf("a=")===0&&(e=JSON.parse(JSON.stringify(e)),e.candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new r(e),o=m.parseCandidate(e.candidate),s=Object.assign(n,o);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new r(e)},t.RTCIceCandidate.prototype=r.prototype,F(t,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"}),e))}function W(t,r){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const e=function(p){if(!p||!p.sdp)return!1;const a=m.splitSections(p.sdp);return a.shift(),a.some(i=>{const d=m.parseMLine(i);return d&&d.kind==="application"&&d.protocol.indexOf("SCTP")!==-1})},n=function(p){const a=p.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(a===null||a.length<2)return-1;const i=parseInt(a[1],10);return i!==i?-1:i},o=function(p){let a=65536;return r.browser==="firefox"&&(r.version<57?p===-1?a=16384:a=2147483637:r.version<60?a=r.version===57?65535:65536:a=2147483637),a},s=function(p,a){let i=65536;r.browser==="firefox"&&r.version===57&&(i=65535);const d=m.matchPrefix(p.sdp,"a=max-message-size:");return d.length>0?i=parseInt(d[0].substr(19),10):r.browser==="firefox"&&a!==-1&&(i=2147483637),i},c=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,r.browser==="chrome"&&r.version>=76){const{sdpSemantics:p}=this.getConfiguration();p==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){const p=n(arguments[0]),a=o(p),i=s(arguments[0],p);let d;a===0&&i===0?d=Number.POSITIVE_INFINITY:a===0||i===0?d=Math.max(a,i):d=Math.min(a,i);const u={};Object.defineProperty(u,"maxMessageSize",{get(){return d}}),this._sctp=u}return c.apply(this,arguments)}}function J(t){if(!(t.RTCPeerConnection&&"createDataChannel"in t.RTCPeerConnection.prototype))return;function r(n,o){const s=n.send;n.send=function(){const c=arguments[0],p=c.length||c.size||c.byteLength;if(n.readyState==="open"&&o.sctp&&p>o.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+o.sctp.maxMessageSize+" bytes)");return s.apply(n,arguments)}}const e=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const n=e.apply(this,arguments);return r(n,this),n},F(t,"datachannel",n=>(r(n.channel,n.target),n))}function ce(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const r=t.RTCPeerConnection.prototype;Object.defineProperty(r,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(r,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const n=r[e];r[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=o=>{const s=o.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const c=new Event("connectionstatechange",o);s.dispatchEvent(c)}return o},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function de(t,r){if(!t.RTCPeerConnection||r.browser==="chrome"&&r.version>=71||r.browser==="safari"&&r.version>=605)return;const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const o=n.sdp.split(`
`).filter(s=>s.trim()!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&n instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:n.type,sdp:o}):n.sdp=o}return e.apply(this,arguments)}}function X(t,r){if(!(t.RTCPeerConnection&&t.RTCPeerConnection.prototype))return;const e=t.RTCPeerConnection.prototype.addIceCandidate;!e||e.length===0||(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(r.browser==="chrome"&&r.version<78||r.browser==="firefox"&&r.version<68||r.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}var Gt=Object.freeze({__proto__:null,shimRTCIceCandidate:K,shimMaxMessageSize:W,shimSendThrowTypeError:J,shimConnectionState:ce,removeExtmapAllowMixed:de,shimAddIceCandidateNullOrEmpty:X});function Ft({window:t}={},r={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const e=It(t),n={browserDetails:e,commonShim:Gt,extractVersion:z,disableLog:wt,disableWarnings:kt};switch(e.browser){case"chrome":if(!_e||!ae||!r.shimChrome||e.version===null)return n;n.browserShim=_e,X(t,e),Me(t,e),Ae(t),ae(t,e),Le(t),Ve(t,e),je(t),Ne(t),Ge(t),Ue(t,e),K(t),ce(t),W(t,e),J(t),de(t,e);break;case"firefox":if(!De||!se||!r.shimFirefox)return n;n.browserShim=De,X(t,e),Je(t,e),se(t,e),$e(t),Xe(t),He(t),Ke(t),qe(t),Ye(t),Ze(t),Qe(t),et(t),K(t),ce(t),W(t,e),J(t);break;case"edge":if(!ke||!oe||!r.shimEdge)return n;n.browserShim=ke,Be(t),ze(t),oe(t,e),We(t),W(t,e),J(t);break;case"safari":if(!Ie||!r.shimSafari)return n;n.browserShim=Ie,X(t,e),ot(t),ct(t),nt(t),tt(t),rt(t),st(t),it(t),dt(t),K(t),W(t,e),J(t),de(t,e);break}return n}Ft({window:typeof window>"u"?void 0:window});class q{constructor(r){if(!Object.values(O).some(e=>e===r))throw new TypeError("Invalid source.");this.source=r,this.deviceId=void 0}}class pe{constructor(r){if(!Object.values(A).some(e=>e===r))throw new TypeError("Invalid source.");this.source=r,this.deviceId=void 0,this.resolution=void 0,this.frameRate=void 0}}class pt{constructor(r=!1,e=!1){this.audio=r,this.video=e}}function H(t){return typeof t.video=="object"&&t.video.source===A.SCREENCAST}class ut{static createMediaStream(r){if(typeof r!="object"||!r.audio&&!r.video)return Promise.reject(new TypeError("Invalid constrains"));if(!H(r)&&typeof r.audio=="object"&&r.audio.source===O.SCREENCAST)return Promise.reject(new TypeError("Cannot share screen without video."));if(H(r)&&!Pt()&&!Se())return Promise.reject(new TypeError("Screen sharing only supports Chrome and Firefox."));if(H(r)&&typeof r.audio=="object"&&r.audio.source!==O.SCREENCAST)return Promise.reject(new TypeError("Cannot capture video from screen cast while capture audio from other source."));if(!r.audio&&!r.video)return Promise.reject(new TypeError("At least one of audio and video must be requested."));const e=Object.create({});return typeof r.audio=="object"&&r.audio.source===O.MIC?(e.audio=Object.create({}),_t()?e.audio.deviceId=r.audio.deviceId:e.audio.deviceId={exact:r.audio.deviceId}):r.audio.source===O.SCREENCAST?e.audio=!0:e.audio=r.audio,typeof r.video=="object"?(e.video=Object.create({}),typeof r.video.frameRate=="number"&&(e.video.frameRate=r.video.frameRate),r.video.resolution&&r.video.resolution.width&&r.video.resolution.height&&(r.video.source===A.SCREENCAST?(e.video.width=r.video.resolution.width,e.video.height=r.video.resolution.height):(e.video.width=Object.create({}),e.video.width.exact=r.video.resolution.width,e.video.height=Object.create({}),e.video.height.exact=r.video.resolution.height)),typeof r.video.deviceId=="string"&&(e.video.deviceId={exact:r.video.deviceId}),Se()&&r.video.source===A.SCREENCAST&&(e.video.mediaSource="screen")):e.video=r.video,H(r)?navigator.mediaDevices.getDisplayMedia(e):navigator.mediaDevices.getUserMedia(e)}}Object.freeze({__proto__:null,AudioTrackConstraints:q,VideoTrackConstraints:pe,StreamConstraints:pt,MediaStreamFactory:ut,AudioSourceInfo:O,VideoSourceInfo:A,TrackKind:bt,Resolution:Oe});let ue,le;function Vt(){ue=console.log,le=console.error}function M(t,...r){ue&&ue(t,...r)}function N(t,...r){le&&le(t,...r)}class Ut{constructor(r){this.listener={},this.type=r|""}on(r,e){return this.listener[r]||(this.listener[r]=[]),this.listener[r].push(e),!0}off(r,e){if(this.listener[r]){var n=this.listener[r].indexOf(e);return n>-1&&this.listener[r].splice(n,1),!0}return!1}offAll(){this.listener={}}dispatch(r,e){return this.listener[r]?(this.listener[r].map(n=>{n.apply(null,[e])}),!0):!1}}class Bt extends Ut{constructor(r){super("RTCPusherPlayer"),this.TAG="[RTCPusherPlayer]";let e={element:"",debug:!1,zlmsdpUrl:"",simulcast:!1,useCamera:!0,audioEnable:!0,videoEnable:!0,recvOnly:!1,resolution:{w:0,h:0}};this.options=Object.assign({},e,r),this.options.debug&&Vt(),this.e={onicecandidate:this._onIceCandidate.bind(this),ontrack:this._onTrack.bind(this),onicecandidateerror:this._onIceCandidateError.bind(this),onconnectionstatechange:this._onconnectionstatechange.bind(this)},this._remoteStream=null,this._localStream=null,this.pc=new RTCPeerConnection(null),this.pc.onicecandidate=this.e.onicecandidate,this.pc.onicecandidateerror=this.e.onicecandidateerror,this.pc.ontrack=this.e.ontrack,this.pc.onconnectionstatechange=this.e.onconnectionstatechange,!this.options.recvOnly&&(this.options.audioEnable||this.options.videoEnable)?this.start():this.receive()}receive(){const r={direction:"recvonly",sendEncodings:[]},e={direction:"recvonly",sendEncodings:[]};this.pc.addTransceiver("audio",r),this.pc.addTransceiver("video",e),this.pc.createOffer().then(n=>{M(this.TAG,"offer:",n.sdp),this.pc.setLocalDescription(n).then(()=>{ne.default({method:"post",url:this.options.zlmsdpUrl,responseType:"json",data:n.sdp,headers:{"Content-Type":"text/plain;charset=utf-8"}}).then(o=>{let s=o.data;if(s.code!=0){this.dispatch(x.WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED,s);return}let c={};c.sdp=s.sdp,c.type="answer",M(this.TAG,"answer:",s.sdp),this.pc.setRemoteDescription(c).then(()=>{M(this.TAG,"set remote sucess")}).catch(p=>{N(this.TAG,p)})})})}).catch(n=>{N(this.TAG,n)})}start(){let r=!1,e=!1;this.options.useCamera?(this.options.videoEnable&&(r=new pe(A.CAMERA)),this.options.audioEnable&&(e=new q(O.MIC))):this.options.videoEnable?(r=new pe(A.SCREENCAST),this.options.audioEnable&&(e=new q(O.SCREENCAST))):this.options.audioEnable?e=new q(O.MIC):N(this.TAG,"error paramter"),this.options.resolution.w!=0&&this.options.resolution.h!=0&&typeof r=="object"&&(r.resolution=new Oe(this.options.resolution.w,this.options.resolution.h)),ut.createMediaStream(new pt(e,r)).then(n=>{this._localStream=n,this.dispatch(x.WEBRTC_ON_LOCAL_STREAM,n);const o={direction:"sendrecv",sendEncodings:[]},s={direction:"sendrecv",sendEncodings:[]};this.options.simulcast&&n.getVideoTracks().length>0&&(s.sendEncodings=[{rid:"h",active:!0,maxBitrate:1e6},{rid:"m",active:!0,maxBitrate:5e5,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:2e5,scaleResolutionDownBy:4}]),n.getAudioTracks().length>0?this.pc.addTransceiver(n.getAudioTracks()[0],o):(o.direction="recvonly",this.pc.addTransceiver("audio",o)),n.getVideoTracks().length>0?this.pc.addTransceiver(n.getVideoTracks()[0],s):(s.direction="recvonly",this.pc.addTransceiver("video",s)),this.pc.createOffer().then(c=>{M(this.TAG,"offer:",c.sdp),this.pc.setLocalDescription(c).then(()=>{ne.default({method:"post",url:this.options.zlmsdpUrl,responseType:"json",data:c.sdp,headers:{"Content-Type":"text/plain;charset=utf-8"}}).then(p=>{let a=p.data;if(a.code!=0){this.dispatch(x.WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED,a);return}let i={};i.sdp=a.sdp,i.type="answer",M(this.TAG,"answer:",a.sdp),this.pc.setRemoteDescription(i).then(()=>{M(this.TAG,"set remote sucess")}).catch(d=>{N(this.TAG,d)})})})}).catch(c=>{N(this.TAG,c)})}).catch(n=>{this.dispatch(x.CAPTURE_STREAM_FAILED)})}_onIceCandidate(r){r.candidate&&M(`Remote ICE candidate: 
 `+r.candidate.candidate)}_onTrack(r){this.options.element&&r.streams&&r.streams.length>0?(this.options.element.srcObject=r.streams[0],this._remoteStream=r.streams[0],this.dispatch(x.WEBRTC_ON_REMOTE_STREAMS,r)):N("element pararm is failed")}_onIceCandidateError(r){this.dispatch(x.WEBRTC_ICE_CANDIDATE_ERROR,r)}_onconnectionstatechange(r){this.dispatch(x.WEBRTC_ON_CONNECTION_STATE_CHANGE,this.pc.connectionState)}close(){this.pc&&(this.pc.close(),this.pc=null),this.options&&(this.options=null),this._localStream&&this._localStream.getTracks().forEach((r,e)=>{r.stop()}),this._remoteStream&&this._remoteStream.getTracks().forEach((r,e)=>{r.stop()})}get remoteStream(){return this._remoteStream}get localStream(){return this._localStream}}const G=x,zt=Bt,Wt=async(t,r,e,n)=>{let o;const s=await fetch(`/api/vms/v1/camera/getByUuid?uuid=${t}`,{method:"GET",headers:{token:n||sessionStorage.getItem("token")||""}}),c=await s.json(),p=await fetch(`/api/vms/v1/camera/getWebrtcUrls?uuid=${t}`,{method:"GET",headers:{token:n||sessionStorage.getItem("token")||""}}),a=await p.json();if(s.status===200){const i=c.data;p.status===200&&(i.webrtcTemplateMerged=a.data[0],i.mediaServerPo.url=a.data[2]);let d=i.webrtcTemplateMerged;o=new lt({plays:{videoElm:r,videoDom:e,mediaServerAddr:i.mediaServerPo.url,cameraUserName:i.user,cameraPwd:i.pass,cameraIp:i.ip,cameraRtspPort:i.rtspPort,cameraChannel:i.channel,cameraStream:i.streamType,addRtspProxyUrl:d}})}return o};class lt{constructor(r){this.init(r)}dom;p_player;playerMap=new Map;streamMap=new Map;mediaServerAddrMap=new Map;config={w:100,h:100,endpointConfig:{}};createRtspUrl(r){const{cameraIp:e,cameraRtspPort:n,cameraChannel:o,cameraStream:s,mediaServerAddr:c,addRtspProxyUrl:p}=r;return{stream:`v${e}-${n}-${o}-${s}`,addRtspProxyUrl:p,sdpUrl:c}}init(r){if(r.endpointConfig&&(this.config.endpointConfig=r.endpointConfig),r.h&&(this.config.h=r.h),r.w&&(this.config.w=r.w),Object.prototype.toString.call(r.plays)==="[object Object]")this.p_player=this.createVideo(r.plays);else for(const e of r.plays)this.createVideo(e)}createVideo(r){this.mediaServerAddrMap.set(r.videoElm,r);const{addRtspProxyUrl:e}=this.createRtspUrl(r);return new Promise((n,o)=>{fetch(e,{method:"GET"}).then(s=>{s.json().then(c=>{c.code===0?(this.startPlay(r),n(c)):(this.mediaServerAddrMap.delete(r.videoElm),o(),this.log("err","\u4ECE\u670D\u52A1\u7AEF\u62C9\u6D41\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5"))})})})}log(r,e){switch(r){case"err":throw new Error(e)}}stopPlay(r){if(r){let e=this.playerMap.get(r);e&&(e.close(),this.playerMap.delete(r),this.mediaServerAddrMap.delete(r),e=null)}else this.playerMap.forEach(e=>{e.close(),e=null}),this.playerMap.clear(),this.mediaServerAddrMap.clear()}playEvent(r,e,n){r.on(G.WEBRTC_ICE_CANDIDATE_ERROR,o=>{this.log("err","ICE \u534F\u5546\u51FA\u9519"),this.rePlay(e)}),r.on(G.WEBRTC_ON_REMOTE_STREAMS,o=>{}),r.on(G.WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED,o=>{this.log("warn",`offer anwser \u4EA4\u6362\u5931\u8D25\uFF0C\u83B7\u53D6\u89C6\u9891\u6D41\u5931\u8D25, ${o}`),this.rePlay(e)}),r.on(G.DISCONNECTED,o=>{this.log("warn",`\u4E8B\u4EF6\u68C0\u6D4B\u5230\u8FDE\u63A5\u65AD\u5F00${e}`),this.rePlay(e)}),r.on(G.LOST_SERVER,o=>{this.log("warn",`\u4E8B\u4EF6\u68C0\u6D4B\u5230\u89C6\u9891\u670D\u52A1\u5668\u4E22\u5931${e}`),this.rePlay(e)}),r.on(G.WEBRTC_ON_CONNECTION_STATE_CHANGE,o=>{(o==="disconnected"||o==="failed")&&this.rePlay(e)})}rePlay(r){setTimeout(()=>{this.play(r)},3e3)}play(r){const e=this.mediaServerAddrMap.get(r),{sdpUrl:n}=this.createRtspUrl(e),{w:o,h:s}=this.config,c={element:e.videoDom||document.getElementById(r),debug:!1,zlmsdpUrl:n,simulcast:!1,useCamera:!1,audioEnable:!1,videoEnable:!0,recvOnly:!0,resolution:{w:o,h:s}},p=new zt({...Object.assign(c,this.config.endpointConfig)});this.playEvent(p,r,n),this.playerMap.set(r,p)}startPlay(r){setTimeout(()=>{this.play(r.videoElm)},100)}}function ht(t,r){if(t===null||r===null)return t==r;if(typeof t=="object"&&typeof r=="object"){const e=Object.keys(t),n=Object.keys(r);if(e.length!==n.length)return!1;for(const o of e)if(!ht(t[o],r[o]))return!1;return!0}else return t===r}const V=t=>{const r=t??sessionStorage.getItem("token");if(!r)throw new Error("\u6CA1\u6709token\uFF0C\u4E0D\u80FD\u83B7\u53D6");return{token:r,"Content-Type":"application/json;charset=utf-8"}};function Jt(t){const{token:r,delay:e=5e3,onChange:n,onPolling:o}=t;let s;try{s=V(r)}catch{}let c=null;const p=async()=>{const l=await fetch("/api/alarmlite/v1/record/list",{method:"POST",headers:s,body:JSON.stringify({pageNum:1,pageSize:999,status:"ALARMING"})}),{data:h}=await l.json();return h.records},a=async(l,h,f,y)=>{const T=await fetch(`/api/thing/v1/adapter/thing/relation/findZInstsByClass/${l}/DEVICE_CAMERA`,{method:"GET",headers:s}),{data:v}=await T.json(),g=v.map(E=>({cameraId:E.thingInst.id,cameraCode:E.thingInst.code}));return{alarmId:f,alarmName:y,thingId:l,thingCode:h,cameraList:g}};let i=[];const d=async()=>{const l=await p(),h=!ht(i,l);i=l;const f=l.map(T=>a(T.instanceUuid,T.instanceCode,T.id,T.name)),y=await Promise.all(f);h&&n?.(y,l),o?.(y,l)};d(),c=setInterval(d,e);function u(){c&&clearInterval(c)}return u}const $t=async(t,r)=>{let e;try{e=V(r)}catch{}return(await fetch("/api/thing/v1/adapter/thing/common/findAlarmDevice",{method:"POST",headers:e,body:JSON.stringify({pageNum:1,pageSize:999,status:"ALARMING"})})).json()},Ht=async(t,r)=>{const e=V(r);return(await ne.default.post("/api/thing/v1/metric/data/getDataList",t,{headers:e})).data.data},ft=t=>{for(let r of t.detailGroupList)r.thingPropertyValueVoList=r.thingPropertyValueVoList.filter(e=>e.eventEnable);return t},mt=t=>{let r=[];for(let e in t)r.push(e+"="+t[e]);return r.join("&")},vt=async(t,r)=>{const e=await fetch("/api/mtip/thing/v2/thingInst/findByCodeList?"+mt(r),{method:"POST",headers:V(r.token),body:JSON.stringify(t)}),n={},o=await e.json();if(!o.data)return n;for(let s of t){n[s]=null;for(let c of o.data)if(c.thingInstEntity.code===s)for(let p of c.detailGroupList)for(let a of p.thingPropertyValueVoList)n[s]=ft(c)}return n},gt=async(t,r)=>{const e=[];for(let o in t){const s=t[o];if(s)for(let c in s.detailGroupList)for(let p in s.detailGroupList[c].thingPropertyValueVoList)s.detailGroupList[c].thingPropertyValueVoList[p].pointCode&&e.push({pointCode:s.detailGroupList[c].thingPropertyValueVoList[p].pointCode,value:s.detailGroupList[c].thingPropertyValueVoList[p].value})}const n=await(await fetch("/api/mtip/thing/v2/thingInst/reloadPropertiesValue",{method:"POST",headers:V(r),body:JSON.stringify(e)})).json();if(!n.data)return t;for(let o of n.data)for(let s in t){const c=t[s];if(c)for(let p in c.detailGroupList)for(let a in c.detailGroupList[p].thingPropertyValueVoList)c.detailGroupList[p].thingPropertyValueVoList[a].pointCode===o.pointCode&&(c.detailGroupList[p].thingPropertyValueVoList[a].value=o.value)}return t},he=async(t,r)=>{const e=await vt(t,r);return async n=>{const o=await gt(e),s={};if(n&&n.length>0)for(let c in o){const p=o[c];if(p)for(let a in p.detailGroupList)for(let i in p.detailGroupList[a].thingPropertyValueVoList)n.includes(p.detailGroupList[a].thingPropertyValueVoList[i].thingPropertyCode)&&(s[c]={pointCode:p.detailGroupList[a].thingPropertyValueVoList[i].pointCode,value:p.detailGroupList[a].thingPropertyValueVoList[i].value})}return n?s:o}},Kt=async(t,r)=>{const e=await he(t,r);return()=>e(["DEVICE_STATE"])},Xt=async(t,r)=>{const e=await he(t,r);return async n=>{const o=await e(),s={};for(let c in o){s[c]={};for(let a of n)s[c][a]=null;const p=o[c];if(p)for(let a in p.detailGroupList)for(let i in p.detailGroupList[a].thingPropertyValueVoList){const d=p.detailGroupList[a].thingPropertyValueVoList[i].thingPropertyCode,u=p.detailGroupList[a].thingPropertyValueVoList[i];n.includes(d)&&(s[c][d]=u)}}return s}},yt=(t,r)=>{const e={thingInstCode:"",thingInstName:"",pageNum:1,pageSize:100,relaThingCode:"",thingCode:t.thingCode,thingInstId:t.thingInstId,thingRelationId:""};for(let n of t.detailGroupList)for(let o of n.thingPropertyValueVoList)o.thingPropertyCode===r&&(e.thingRelationId=o.value),o.thingPropertyCode===r&&(e.relaThingCode=o.relationThingCode);return e},qt=async(t,r,e)=>{const n=yt(t,r),o=await fetch("/api/mtip/thing/v2/thingInst/findRelationEntitiesPage?"+mt(e),{headers:V(e.token),method:"POST",body:JSON.stringify(n)}),s=[],c=await o.json();if(!c.data)return{deviceCodeList:s,resData:c};for(let p of c.data.list)for(let a of p.listPropertyList)a.thingPropertyCode==="CODE"&&s.push(a.value);return{deviceCodeList:s,resData:c}};exports.GetDeviceDetailOnce=vt;exports.InjectDeveiceCodeGetDetailByPc=Xt;exports.InjectDeviceCodeGetDetail=he;exports.InjectDeviceCodeGetState=Kt;exports.RefreshDeviceDetail=gt;exports.WebRtcMt=lt;exports.filterDataByEventEnable=ft;exports.findAlarmDeviceById=$t;exports.findRelationEntitiesPage=qt;exports.getAlarmingCamera=Jt;exports.getCorrelationInts=yt;exports.getDeviceList=Ht;exports.playOneWebRtcMt=Wt;
