import ne from"axios";const x={WEBRTC_NOT_SUPPORT:"WEBRTC_NOT_SUPPORT",WEBRTC_ICE_CANDIDATE_ERROR:"WEBRTC_ICE_CANDIDATE_ERROR",WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED:"WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED",WEBRTC_ON_REMOTE_STREAMS:"WEBRTC_ON_REMOTE_STREAMS",WEBRTC_ON_LOCAL_STREAM:"WEBRTC_ON_LOCAL_STREAM",WEBRTC_ON_CONNECTION_STATE_CHANGE:"WEBRTC_ON_CONNECTION_STATE_CHANGE",CAPTURE_STREAM_FAILED:"CAPTURE_STREAM_FAILED"};function Te(){return window.navigator.userAgent.match("Firefox")!==null}function gt(){return window.navigator.userAgent.match("Chrome")!==null}function yt(){return window.navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)!==null}const O={MIC:"mic",SCREENCAST:"screen-cast",FILE:"file",MIXED:"mixed"},A={CAMERA:"camera",SCREENCAST:"screen-cast",FILE:"file",MIXED:"mixed"},Ct={AUDIO:"audio",VIDEO:"video",AUDIO_AND_VIDEO:"av"};class Ie{constructor(r,e){this.width=r,this.height=e}}function z(t,r,e){const n=t.match(r);return n&&n.length>=e&&parseInt(n[e],10)}function F(t,r,e){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype,a=n.addEventListener;n.addEventListener=function(c,p){if(c!==r)return a.apply(this,arguments);const o=i=>{const d=e(i);d&&(p.handleEvent?p.handleEvent(d):p(d))};return this._eventMap=this._eventMap||{},this._eventMap[r]||(this._eventMap[r]=new Map),this._eventMap[r].set(p,o),a.apply(this,[c,o])};const s=n.removeEventListener;n.removeEventListener=function(c,p){if(c!==r||!this._eventMap||!this._eventMap[r])return s.apply(this,arguments);if(!this._eventMap[r].has(p))return s.apply(this,arguments);const o=this._eventMap[r].get(p);return this._eventMap[r].delete(p),this._eventMap[r].size===0&&delete this._eventMap[r],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[c,o])},Object.defineProperty(n,"on"+r,{get(){return this["_on"+r]},set(c){this["_on"+r]&&(this.removeEventListener(r,this["_on"+r]),delete this["_on"+r]),c&&this.addEventListener(r,this["_on"+r]=c)},enumerable:!0,configurable:!0})}function Tt(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):t?"adapter.js logging disabled":"adapter.js logging enabled"}function St(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):"adapter.js deprecation warnings "+(t?"disabled":"enabled")}function Rt(){}function Et(t){const r={browser:null,version:null};if(typeof t>"u"||!t.navigator)return r.browser="Not a browser.",r;const{navigator:e}=t;if(e.mozGetUserMedia)r.browser="firefox",r.version=z(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||t.isSecureContext===!1&&t.webkitRTCPeerConnection&&!t.RTCIceGatherer)r.browser="chrome",r.version=z(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(e.mediaDevices&&e.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=z(e.userAgent,/Edge\/(\d+).(\d+)$/,2);else if(t.RTCPeerConnection&&e.userAgent.match(/AppleWebKit\/(\d+)\./))r.browser="safari",r.version=z(e.userAgent,/AppleWebKit\/(\d+)\./,1),r.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype;else return r.browser="Not a supported browser.",r;return r}function Se(t){return Object.prototype.toString.call(t)==="[object Object]"}function Oe(t){return Se(t)?Object.keys(t).reduce(function(r,e){const n=Se(t[e]),a=n?Oe(t[e]):t[e],s=n&&!Object.keys(a).length;return a===void 0||s?r:Object.assign(r,{[e]:a})},{}):t}function ie(t,r,e){!r||e.has(r.id)||(e.set(r.id,r),Object.keys(r).forEach(n=>{n.endsWith("Id")?ie(t,t.get(r[n]),e):n.endsWith("Ids")&&r[n].forEach(a=>{ie(t,t.get(a),e)})}))}function Re(t,r,e){const n=e?"outbound-rtp":"inbound-rtp",a=new Map;if(r===null)return a;const s=[];return t.forEach(c=>{c.type==="track"&&c.trackIdentifier===r.id&&s.push(c)}),s.forEach(c=>{t.forEach(p=>{p.type===n&&p.trackId===c.id&&ie(t,p,a)})}),a}const Ee=Rt;function xe(t,r){const e=t&&t.navigator;if(!e.mediaDevices)return;const n=function(p){if(typeof p!="object"||p.mandatory||p.optional)return p;const o={};return Object.keys(p).forEach(i=>{if(i==="require"||i==="advanced"||i==="mediaSource")return;const d=typeof p[i]=="object"?p[i]:{ideal:p[i]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const u=function(l,h){return l?l+h.charAt(0).toUpperCase()+h.slice(1):h==="deviceId"?"sourceId":h};if(d.ideal!==void 0){o.optional=o.optional||[];let l={};typeof d.ideal=="number"?(l[u("min",i)]=d.ideal,o.optional.push(l),l={},l[u("max",i)]=d.ideal,o.optional.push(l)):(l[u("",i)]=d.ideal,o.optional.push(l))}d.exact!==void 0&&typeof d.exact!="number"?(o.mandatory=o.mandatory||{},o.mandatory[u("",i)]=d.exact):["min","max"].forEach(l=>{d[l]!==void 0&&(o.mandatory=o.mandatory||{},o.mandatory[u(l,i)]=d[l])})}),p.advanced&&(o.optional=(o.optional||[]).concat(p.advanced)),o},a=function(p,o){if(r.version>=61)return o(p);if(p=JSON.parse(JSON.stringify(p)),p&&typeof p.audio=="object"){const i=function(d,u,l){u in d&&!(l in d)&&(d[l]=d[u],delete d[u])};p=JSON.parse(JSON.stringify(p)),i(p.audio,"autoGainControl","googAutoGainControl"),i(p.audio,"noiseSuppression","googNoiseSuppression"),p.audio=n(p.audio)}if(p&&typeof p.video=="object"){let i=p.video.facingMode;i=i&&(typeof i=="object"?i:{ideal:i});const d=r.version<66;if(i&&(i.exact==="user"||i.exact==="environment"||i.ideal==="user"||i.ideal==="environment")&&!(e.mediaDevices.getSupportedConstraints&&e.mediaDevices.getSupportedConstraints().facingMode&&!d)){delete p.video.facingMode;let u;if(i.exact==="environment"||i.ideal==="environment"?u=["back","rear"]:(i.exact==="user"||i.ideal==="user")&&(u=["front"]),u)return e.mediaDevices.enumerateDevices().then(l=>{l=l.filter(m=>m.kind==="videoinput");let h=l.find(m=>u.some(y=>m.label.toLowerCase().includes(y)));return!h&&l.length&&u.includes("back")&&(h=l[l.length-1]),h&&(p.video.deviceId=i.exact?{exact:h.deviceId}:{ideal:h.deviceId}),p.video=n(p.video),Ee("chrome: "+JSON.stringify(p)),o(p)})}p.video=n(p.video)}return Ee("chrome: "+JSON.stringify(p)),o(p)},s=function(p){return r.version>=64?p:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[p.name]||p.name,message:p.message,constraint:p.constraint||p.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},c=function(p,o,i){a(p,d=>{e.webkitGetUserMedia(d,o,u=>{i&&i(s(u))})})};if(e.getUserMedia=c.bind(e),e.mediaDevices.getUserMedia){const p=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(o){return a(o,i=>p(i).then(d=>{if(i.audio&&!d.getAudioTracks().length||i.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(u=>{u.stop()}),new DOMException("","NotFoundError");return d},d=>Promise.reject(s(d))))}}}function Pt(t,r){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&typeof r=="function"&&(t.navigator.mediaDevices.getDisplayMedia=function(e){return r(e).then(n=>{const a=e.video&&e.video.width,s=e.video&&e.video.height,c=e.video&&e.video.frameRate;return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:c||3}},a&&(e.video.mandatory.maxWidth=a),s&&(e.video.mandatory.maxHeight=s),t.navigator.mediaDevices.getUserMedia(e)})})}function Me(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function Ae(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",n=>{let a;t.RTCPeerConnection.prototype.getReceivers?a=this.getReceivers().find(c=>c.track&&c.track.id===n.track.id):a={track:n.track};const s=new Event("track");s.track=n.track,s.receiver=a,s.transceiver={receiver:a},s.streams=[e.stream],this.dispatchEvent(s)}),e.stream.getTracks().forEach(n=>{let a;t.RTCPeerConnection.prototype.getReceivers?a=this.getReceivers().find(c=>c.track&&c.track.id===n.id):a={track:n};const s=new Event("track");s.track=n,s.receiver=a,s.transceiver={receiver:a},s.streams=[e.stream],this.dispatchEvent(s)})},this.addEventListener("addstream",this._ontrackpoly)),r.apply(this,arguments)}}else F(t,"track",r=>(r.transceiver||Object.defineProperty(r,"transceiver",{value:{receiver:r.receiver}}),r))}function Le(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const r=function(a,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=a.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:a}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const a=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(c,p){let o=a.apply(this,arguments);return o||(o=r(this,c),this._senders.push(o)),o};const s=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(c){s.apply(this,arguments);const p=this._senders.indexOf(c);p!==-1&&this._senders.splice(p,1)}}const e=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(a){this._senders=this._senders||[],e.apply(this,[a]),a.getTracks().forEach(s=>{this._senders.push(r(this,s))})};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(a){this._senders=this._senders||[],n.apply(this,[a]),a.getTracks().forEach(s=>{const c=this._senders.find(p=>p.track===s);c&&this._senders.splice(this._senders.indexOf(c),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const r=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const e=r.apply(this,[]);return e.forEach(n=>n._pc=this),e},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function je(t){if(!t.RTCPeerConnection)return;const r=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[e,n,a]=arguments;if(arguments.length>0&&typeof e=="function")return r.apply(this,arguments);if(r.length===0&&(arguments.length===0||typeof e!="function"))return r.apply(this,[]);const s=function(p){const o={};return p.result().forEach(i=>{const d={id:i.id,timestamp:i.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[i.type]||i.type};i.names().forEach(u=>{d[u]=i.stat(u)}),o[d.id]=d}),o},c=function(p){return new Map(Object.keys(p).map(o=>[o,p[o]]))};if(arguments.length>=2){const p=function(o){n(c(s(o)))};return r.apply(this,[p,e])}return new Promise((p,o)=>{r.apply(this,[function(i){p(c(s(i)))},o])}).then(n,a)}}function Ne(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const a=e.apply(this,[]);return a.forEach(s=>s._pc=this),a});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const a=n.apply(this,arguments);return a._pc=this,a}),t.RTCRtpSender.prototype.getStats=function(){const a=this;return this._pc.getStats().then(s=>Re(s,a.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(a=>a._pc=this),n}),F(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(a=>Re(a,n.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype&&"getStats"in t.RTCRtpReceiver.prototype))return;const r=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const e=arguments[0];let n,a,s;return this.getSenders().forEach(c=>{c.track===e&&(n?s=!0:n=c)}),this.getReceivers().forEach(c=>(c.track===e&&(a?s=!0:a=c),c.track===e)),s||n&&a?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():a?a.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return r.apply(this,arguments)}}function Ge(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(s=>this._shimmedLocalStreams[s][0])};const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,c){if(!c)return r.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const p=r.apply(this,arguments);return this._shimmedLocalStreams[c.id]?this._shimmedLocalStreams[c.id].indexOf(p)===-1&&this._shimmedLocalStreams[c.id].push(p):this._shimmedLocalStreams[c.id]=[c,p],p};const e=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach(o=>{if(this.getSenders().find(i=>i.track===o))throw new DOMException("Track already exists.","InvalidAccessError")});const c=this.getSenders();e.apply(this,arguments);const p=this.getSenders().filter(o=>c.indexOf(o)===-1);this._shimmedLocalStreams[s.id]=[s].concat(p)};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],n.apply(this,arguments)};const a=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach(c=>{const p=this._shimmedLocalStreams[c].indexOf(s);p!==-1&&this._shimmedLocalStreams[c].splice(p,1),this._shimmedLocalStreams[c].length===1&&delete this._shimmedLocalStreams[c]}),a.apply(this,arguments)}}function Fe(t,r){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&r.version>=65)return Ge(t);const e=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const i=e.apply(this);return this._reverseStreams=this._reverseStreams||{},i.map(d=>this._reverseStreams[d.id])};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(i){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[i.id]){const d=new t.MediaStream(i.getTracks());this._streams[i.id]=d,this._reverseStreams[d.id]=i,i=d}n.apply(this,[i])};const a=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(i){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},a.apply(this,[this._streams[i.id]||i]),delete this._reverseStreams[this._streams[i.id]?this._streams[i.id].id:i.id],delete this._streams[i.id]},t.RTCPeerConnection.prototype.addTrack=function(i,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const u=[].slice.call(arguments,1);if(u.length!==1||!u[0].getTracks().find(h=>h===i))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(h=>h.track===i))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const l=this._streams[d.id];if(l)l.addTrack(i),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const h=new t.MediaStream([i]);this._streams[d.id]=h,this._reverseStreams[h.id]=d,this.addStream(h)}return this.getSenders().find(h=>h.track===i)};function s(i,d){let u=d.sdp;return Object.keys(i._reverseStreams||[]).forEach(l=>{const h=i._reverseStreams[l],m=i._streams[h.id];u=u.replace(new RegExp(m.id,"g"),h.id)}),new RTCSessionDescription({type:d.type,sdp:u})}function c(i,d){let u=d.sdp;return Object.keys(i._reverseStreams||[]).forEach(l=>{const h=i._reverseStreams[l],m=i._streams[h.id];u=u.replace(new RegExp(h.id,"g"),m.id)}),new RTCSessionDescription({type:d.type,sdp:u})}["createOffer","createAnswer"].forEach(function(i){const d=t.RTCPeerConnection.prototype[i],u={[i](){const l=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[h=>{const m=s(this,h);l[0].apply(null,[m])},h=>{l[1]&&l[1].apply(null,h)},arguments[2]]):d.apply(this,arguments).then(h=>s(this,h))}};t.RTCPeerConnection.prototype[i]=u[i]});const p=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?p.apply(this,arguments):(arguments[0]=c(this,arguments[0]),p.apply(this,arguments))};const o=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const i=o.get.apply(this);return i.type===""?i:s(this,i)}}),t.RTCPeerConnection.prototype.removeTrack=function(i){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!i._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(i._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let d;Object.keys(this._streams).forEach(u=>{this._streams[u].getTracks().find(l=>i.track===l)&&(d=this._streams[u])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(i.track),this.dispatchEvent(new Event("negotiationneeded")))}}function oe(t,r){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&r.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){const n=t.RTCPeerConnection.prototype[e],a={[e](){return arguments[0]=new(e==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=a[e]})}function Ve(t,r){F(t,"negotiationneeded",e=>{const n=e.target;if(!((r.version<72||n.getConfiguration&&n.getConfiguration().sdpSemantics==="plan-b")&&n.signalingState!=="stable"))return e})}var Pe=Object.freeze({__proto__:null,shimMediaStream:Me,shimOnTrack:Ae,shimGetSendersWithDtmf:Le,shimGetStats:je,shimSenderReceiverGetStats:Ne,shimAddTrackRemoveTrackWithNative:Ge,shimAddTrackRemoveTrack:Fe,shimPeerConnection:oe,fixNegotiationNeeded:Ve,shimGetUserMedia:xe,shimGetDisplayMedia:Pt});function _t(t,r){let e=!1;return t=JSON.parse(JSON.stringify(t)),t.filter(n=>{if(n&&(n.urls||n.url)){let a=n.urls||n.url;n.url&&n.urls;const s=typeof a=="string";return s&&(a=[a]),a=a.filter(c=>{if(c.indexOf("stun:")===0)return!1;const p=c.startsWith("turn")&&!c.startsWith("turn:[")&&c.includes("transport=udp");return p&&!e?(e=!0,!0):p&&!e}),delete n.url,n.urls=s?a[0]:a,!!a.length}})}function bt(t){var r={exports:{}};return t(r,r.exports),r.exports}var f=bt(function(t){var r={};r.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},r.localCName=r.generateIdentifier(),r.splitLines=function(e){return e.trim().split(`
`).map(function(n){return n.trim()})},r.splitSections=function(e){var n=e.split(`
m=`);return n.map(function(a,s){return(s>0?"m="+a:a).trim()+`\r
`})},r.getDescription=function(e){var n=r.splitSections(e);return n&&n[0]},r.getMediaSections=function(e){var n=r.splitSections(e);return n.shift(),n},r.matchPrefix=function(e,n){return r.splitLines(e).filter(function(a){return a.indexOf(n)===0})},r.parseCandidate=function(e){var n;e.indexOf("a=candidate:")===0?n=e.substring(12).split(" "):n=e.substring(10).split(" ");for(var a={foundation:n[0],component:parseInt(n[1],10),protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]},s=8;s<n.length;s+=2)switch(n[s]){case"raddr":a.relatedAddress=n[s+1];break;case"rport":a.relatedPort=parseInt(n[s+1],10);break;case"tcptype":a.tcpType=n[s+1];break;case"ufrag":a.ufrag=n[s+1],a.usernameFragment=n[s+1];break;default:a[n[s]]=n[s+1];break}return a},r.writeCandidate=function(e){var n=[];n.push(e.foundation),n.push(e.component),n.push(e.protocol.toUpperCase()),n.push(e.priority),n.push(e.address||e.ip),n.push(e.port);var a=e.type;return n.push("typ"),n.push(a),a!=="host"&&e.relatedAddress&&e.relatedPort&&(n.push("raddr"),n.push(e.relatedAddress),n.push("rport"),n.push(e.relatedPort)),e.tcpType&&e.protocol.toLowerCase()==="tcp"&&(n.push("tcptype"),n.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(n.push("ufrag"),n.push(e.usernameFragment||e.ufrag)),"candidate:"+n.join(" ")},r.parseIceOptions=function(e){return e.substr(14).split(" ")},r.parseRtpMap=function(e){var n=e.substr(9).split(" "),a={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),a.name=n[0],a.clockRate=parseInt(n[1],10),a.channels=n.length===3?parseInt(n[2],10):1,a.numChannels=a.channels,a},r.writeRtpMap=function(e){var n=e.payloadType;e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType);var a=e.channels||e.numChannels||1;return"a=rtpmap:"+n+" "+e.name+"/"+e.clockRate+(a!==1?"/"+a:"")+`\r
`},r.parseExtmap=function(e){var n=e.substr(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1]}},r.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+`\r
`},r.parseFmtp=function(e){for(var n={},a,s=e.substr(e.indexOf(" ")+1).split(";"),c=0;c<s.length;c++)a=s[c].trim().split("="),n[a[0].trim()]=a[1];return n},r.writeFmtp=function(e){var n="",a=e.payloadType;if(e.preferredPayloadType!==void 0&&(a=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var s=[];Object.keys(e.parameters).forEach(function(c){e.parameters[c]?s.push(c+"="+e.parameters[c]):s.push(c)}),n+="a=fmtp:"+a+" "+s.join(";")+`\r
`}return n},r.parseRtcpFb=function(e){var n=e.substr(e.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},r.writeRtcpFb=function(e){var n="",a=e.payloadType;return e.preferredPayloadType!==void 0&&(a=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(s){n+="a=rtcp-fb:"+a+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),n},r.parseSsrcMedia=function(e){var n=e.indexOf(" "),a={ssrc:parseInt(e.substr(7,n-7),10)},s=e.indexOf(":",n);return s>-1?(a.attribute=e.substr(n+1,s-n-1),a.value=e.substr(s+1)):a.attribute=e.substr(n+1),a},r.parseSsrcGroup=function(e){var n=e.substr(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(function(a){return parseInt(a,10)})}},r.getMid=function(e){var n=r.matchPrefix(e,"a=mid:")[0];if(n)return n.substr(6)},r.parseFingerprint=function(e){var n=e.substr(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1]}},r.getDtlsParameters=function(e,n){var a=r.matchPrefix(e+n,"a=fingerprint:");return{role:"auto",fingerprints:a.map(r.parseFingerprint)}},r.writeDtlsParameters=function(e,n){var a="a=setup:"+n+`\r
`;return e.fingerprints.forEach(function(s){a+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),a},r.parseCryptoLine=function(e){var n=e.substr(9).split(" ");return{tag:parseInt(n[0],10),cryptoSuite:n[1],keyParams:n[2],sessionParams:n.slice(3)}},r.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams=="object"?r.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+`\r
`},r.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;var n=e.substr(7).split("|");return{keyMethod:"inline",keySalt:n[0],lifeTime:n[1],mkiValue:n[2]?n[2].split(":")[0]:void 0,mkiLength:n[2]?n[2].split(":")[1]:void 0}},r.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},r.getCryptoParameters=function(e,n){var a=r.matchPrefix(e+n,"a=crypto:");return a.map(r.parseCryptoLine)},r.getIceParameters=function(e,n){var a=r.matchPrefix(e+n,"a=ice-ufrag:")[0],s=r.matchPrefix(e+n,"a=ice-pwd:")[0];return a&&s?{usernameFragment:a.substr(12),password:s.substr(10)}:null},r.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+`\r
a=ice-pwd:`+e.password+`\r
`},r.parseRtpParameters=function(e){for(var n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},a=r.splitLines(e),s=a[0].split(" "),c=3;c<s.length;c++){var p=s[c],o=r.matchPrefix(e,"a=rtpmap:"+p+" ")[0];if(o){var i=r.parseRtpMap(o),d=r.matchPrefix(e,"a=fmtp:"+p+" ");switch(i.parameters=d.length?r.parseFmtp(d[0]):{},i.rtcpFeedback=r.matchPrefix(e,"a=rtcp-fb:"+p+" ").map(r.parseRtcpFb),n.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(i.name.toUpperCase());break}}}return r.matchPrefix(e,"a=extmap:").forEach(function(u){n.headerExtensions.push(r.parseExtmap(u))}),n},r.writeRtpDescription=function(e,n){var a="";a+="m="+e+" ",a+=n.codecs.length>0?"9":"0",a+=" UDP/TLS/RTP/SAVPF ",a+=n.codecs.map(function(c){return c.preferredPayloadType!==void 0?c.preferredPayloadType:c.payloadType}).join(" ")+`\r
`,a+=`c=IN IP4 0.0.0.0\r
`,a+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,n.codecs.forEach(function(c){a+=r.writeRtpMap(c),a+=r.writeFmtp(c),a+=r.writeRtcpFb(c)});var s=0;return n.codecs.forEach(function(c){c.maxptime>s&&(s=c.maxptime)}),s>0&&(a+="a=maxptime:"+s+`\r
`),a+=`a=rtcp-mux\r
`,n.headerExtensions&&n.headerExtensions.forEach(function(c){a+=r.writeExtmap(c)}),a},r.parseRtpEncodingParameters=function(e){var n=[],a=r.parseRtpParameters(e),s=a.fecMechanisms.indexOf("RED")!==-1,c=a.fecMechanisms.indexOf("ULPFEC")!==-1,p=r.matchPrefix(e,"a=ssrc:").map(function(l){return r.parseSsrcMedia(l)}).filter(function(l){return l.attribute==="cname"}),o=p.length>0&&p[0].ssrc,i,d=r.matchPrefix(e,"a=ssrc-group:FID").map(function(l){var h=l.substr(17).split(" ");return h.map(function(m){return parseInt(m,10)})});d.length>0&&d[0].length>1&&d[0][0]===o&&(i=d[0][1]),a.codecs.forEach(function(l){if(l.name.toUpperCase()==="RTX"&&l.parameters.apt){var h={ssrc:o,codecPayloadType:parseInt(l.parameters.apt,10)};o&&i&&(h.rtx={ssrc:i}),n.push(h),s&&(h=JSON.parse(JSON.stringify(h)),h.fec={ssrc:o,mechanism:c?"red+ulpfec":"red"},n.push(h))}}),n.length===0&&o&&n.push({ssrc:o});var u=r.matchPrefix(e,"b=");return u.length&&(u[0].indexOf("b=TIAS:")===0?u=parseInt(u[0].substr(7),10):u[0].indexOf("b=AS:")===0?u=parseInt(u[0].substr(5),10)*1e3*.95-50*40*8:u=void 0,n.forEach(function(l){l.maxBitrate=u})),n},r.parseRtcpParameters=function(e){var n={},a=r.matchPrefix(e,"a=ssrc:").map(function(p){return r.parseSsrcMedia(p)}).filter(function(p){return p.attribute==="cname"})[0];a&&(n.cname=a.value,n.ssrc=a.ssrc);var s=r.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=s.length>0,n.compound=s.length===0;var c=r.matchPrefix(e,"a=rtcp-mux");return n.mux=c.length>0,n},r.parseMsid=function(e){var n,a=r.matchPrefix(e,"a=msid:");if(a.length===1)return n=a[0].substr(7).split(" "),{stream:n[0],track:n[1]};var s=r.matchPrefix(e,"a=ssrc:").map(function(c){return r.parseSsrcMedia(c)}).filter(function(c){return c.attribute==="msid"});if(s.length>0)return n=s[0].value.split(" "),{stream:n[0],track:n[1]}},r.parseSctpDescription=function(e){var n=r.parseMLine(e),a=r.matchPrefix(e,"a=max-message-size:"),s;a.length>0&&(s=parseInt(a[0].substr(19),10)),isNaN(s)&&(s=65536);var c=r.matchPrefix(e,"a=sctp-port:");if(c.length>0)return{port:parseInt(c[0].substr(12),10),protocol:n.fmt,maxMessageSize:s};var p=r.matchPrefix(e,"a=sctpmap:");if(p.length>0){var o=r.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(o[0],10),protocol:o[1],maxMessageSize:s}}},r.writeSctpDescription=function(e,n){var a=[];return e.protocol!=="DTLS/SCTP"?a=["m="+e.kind+" 9 "+e.protocol+" "+n.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+n.port+`\r
`]:a=["m="+e.kind+" 9 "+e.protocol+" "+n.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+n.port+" "+n.protocol+` 65535\r
`],n.maxMessageSize!==void 0&&a.push("a=max-message-size:"+n.maxMessageSize+`\r
`),a.join("")},r.generateSessionId=function(){return Math.random().toString().substr(2,21)},r.writeSessionBoilerplate=function(e,n,a){var s,c=n!==void 0?n:2;e?s=e:s=r.generateSessionId();var p=a||"thisisadapterortc";return`v=0\r
o=`+p+" "+s+" "+c+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},r.writeMediaSection=function(e,n,a,s){var c=r.writeRtpDescription(e.kind,n);if(c+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),c+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),a==="offer"?"actpass":"active"),c+="a=mid:"+e.mid+`\r
`,e.direction?c+="a="+e.direction+`\r
`:e.rtpSender&&e.rtpReceiver?c+=`a=sendrecv\r
`:e.rtpSender?c+=`a=sendonly\r
`:e.rtpReceiver?c+=`a=recvonly\r
`:c+=`a=inactive\r
`,e.rtpSender){var p="msid:"+s.id+" "+e.rtpSender.track.id+`\r
`;c+="a="+p,c+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+p,e.sendEncodingParameters[0].rtx&&(c+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+p,c+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return c+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+`\r
`,e.rtpSender&&e.sendEncodingParameters[0].rtx&&(c+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+`\r
`),c},r.getDirection=function(e,n){for(var a=r.splitLines(e),s=0;s<a.length;s++)switch(a[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return a[s].substr(2)}return n?r.getDirection(n):"sendrecv"},r.getKind=function(e){var n=r.splitLines(e),a=n[0].split(" ");return a[0].substr(2)},r.isRejected=function(e){return e.split(" ",2)[1]==="0"},r.parseMLine=function(e){var n=r.splitLines(e),a=n[0].substr(2).split(" ");return{kind:a[0],port:parseInt(a[1],10),protocol:a[2],fmt:a.slice(3).join(" ")}},r.parseOLine=function(e){var n=r.matchPrefix(e,"o=")[0],a=n.substr(2).split(" ");return{username:a[0],sessionId:a[1],sessionVersion:parseInt(a[2],10),netType:a[3],addressType:a[4],address:a[5]}},r.isValidSDP=function(e){if(typeof e!="string"||e.length===0)return!1;for(var n=r.splitLines(e),a=0;a<n.length;a++)if(n[a].length<2||n[a].charAt(1)!=="=")return!1;return!0},t.exports=r});function wt(t){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type}function _e(t,r,e,n,a){var s=f.writeRtpDescription(t.kind,r);if(s+=f.writeIceParameters(t.iceGatherer.getLocalParameters()),s+=f.writeDtlsParameters(t.dtlsTransport.getLocalParameters(),e==="offer"?"actpass":a||"active"),s+="a=mid:"+t.mid+`\r
`,t.rtpSender&&t.rtpReceiver?s+=`a=sendrecv\r
`:t.rtpSender?s+=`a=sendonly\r
`:t.rtpReceiver?s+=`a=recvonly\r
`:s+=`a=inactive\r
`,t.rtpSender){var c=t.rtpSender._initialTrackId||t.rtpSender.track.id;t.rtpSender._initialTrackId=c;var p="msid:"+(n?n.id:"-")+" "+c+`\r
`;s+="a="+p,s+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" "+p,t.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" "+p,s+="a=ssrc-group:FID "+t.sendEncodingParameters[0].ssrc+" "+t.sendEncodingParameters[0].rtx.ssrc+`\r
`)}return s+="a=ssrc:"+t.sendEncodingParameters[0].ssrc+" cname:"+f.localCName+`\r
`,t.rtpSender&&t.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+t.sendEncodingParameters[0].rtx.ssrc+" cname:"+f.localCName+`\r
`),s}function kt(t,r){var e=!1;return t=JSON.parse(JSON.stringify(t)),t.filter(function(n){if(n&&(n.urls||n.url)){var a=n.urls||n.url;n.url&&n.urls;var s=typeof a=="string";return s&&(a=[a]),a=a.filter(function(c){var p=c.indexOf("turn:")===0&&c.indexOf("transport=udp")!==-1&&c.indexOf("turn:[")===-1&&!e;return p?(e=!0,!0):c.indexOf("stun:")===0&&r>=14393&&c.indexOf("?transport=udp")===-1}),delete n.url,n.urls=s?a[0]:a,!!a.length}})}function $(t,r){var e={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(s,c){s=parseInt(s,10);for(var p=0;p<c.length;p++)if(c[p].payloadType===s||c[p].preferredPayloadType===s)return c[p]},a=function(s,c,p,o){var i=n(s.parameters.apt,p),d=n(c.parameters.apt,o);return i&&d&&i.name.toLowerCase()===d.name.toLowerCase()};return t.codecs.forEach(function(s){for(var c=0;c<r.codecs.length;c++){var p=r.codecs[c];if(s.name.toLowerCase()===p.name.toLowerCase()&&s.clockRate===p.clockRate){if(s.name.toLowerCase()==="rtx"&&s.parameters&&p.parameters.apt&&!a(s,p,t.codecs,r.codecs))continue;p=JSON.parse(JSON.stringify(p)),p.numChannels=Math.min(s.numChannels,p.numChannels),e.codecs.push(p),p.rtcpFeedback=p.rtcpFeedback.filter(function(o){for(var i=0;i<s.rtcpFeedback.length;i++)if(s.rtcpFeedback[i].type===o.type&&s.rtcpFeedback[i].parameter===o.parameter)return!0;return!1});break}}}),t.headerExtensions.forEach(function(s){for(var c=0;c<r.headerExtensions.length;c++){var p=r.headerExtensions[c];if(s.uri===p.uri){e.headerExtensions.push(p);break}}}),e}function be(t,r,e){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[r][t].indexOf(e)!==-1}function re(t,r){var e=t.getRemoteCandidates().find(function(n){return r.foundation===n.foundation&&r.ip===n.ip&&r.port===n.port&&r.priority===n.priority&&r.protocol===n.protocol&&r.type===n.type});return e||t.addRemoteCandidate(r),!e}function _(t,r){var e=new Error(r);return e.name=t,e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[t],e}var Dt=function(t,r){function e(o,i){i.addTrack(o),i.dispatchEvent(new t.MediaStreamTrackEvent("addtrack",{track:o}))}function n(o,i){i.removeTrack(o),i.dispatchEvent(new t.MediaStreamTrackEvent("removetrack",{track:o}))}function a(o,i,d,u){var l=new Event("track");l.track=i,l.receiver=d,l.transceiver={receiver:d},l.streams=u,t.setTimeout(function(){o._dispatchEvent("track",l)})}var s=function(o){var i=this,d=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(l){i[l]=d[l].bind(d)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",o=JSON.parse(JSON.stringify(o||{})),this.usingBundle=o.bundlePolicy==="max-bundle",o.rtcpMuxPolicy==="negotiate")throw _("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(o.rtcpMuxPolicy||(o.rtcpMuxPolicy="require"),o.iceTransportPolicy){case"all":case"relay":break;default:o.iceTransportPolicy="all";break}switch(o.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:o.bundlePolicy="balanced";break}if(o.iceServers=kt(o.iceServers||[],r),this._iceGatherers=[],o.iceCandidatePoolSize)for(var u=o.iceCandidatePoolSize;u>0;u--)this._iceGatherers.push(new t.RTCIceGatherer({iceServers:o.iceServers,gatherPolicy:o.iceTransportPolicy}));else o.iceCandidatePoolSize=0;this._config=o,this.transceivers=[],this._sdpSessionId=f.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(s.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(s.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),s.prototype.onicecandidate=null,s.prototype.onaddstream=null,s.prototype.ontrack=null,s.prototype.onremovestream=null,s.prototype.onsignalingstatechange=null,s.prototype.oniceconnectionstatechange=null,s.prototype.onconnectionstatechange=null,s.prototype.onicegatheringstatechange=null,s.prototype.onnegotiationneeded=null,s.prototype.ondatachannel=null,s.prototype._dispatchEvent=function(o,i){this._isClosed||(this.dispatchEvent(i),typeof this["on"+o]=="function"&&this["on"+o](i))},s.prototype._emitGatheringStateChange=function(){var o=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",o)},s.prototype.getConfiguration=function(){return this._config},s.prototype.getLocalStreams=function(){return this.localStreams},s.prototype.getRemoteStreams=function(){return this.remoteStreams},s.prototype._createTransceiver=function(o,i){var d=this.transceivers.length>0,u={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:o,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&d)u.iceTransport=this.transceivers[0].iceTransport,u.dtlsTransport=this.transceivers[0].dtlsTransport;else{var l=this._createIceAndDtlsTransports();u.iceTransport=l.iceTransport,u.dtlsTransport=l.dtlsTransport}return i||this.transceivers.push(u),u},s.prototype.addTrack=function(o,i){if(this._isClosed)throw _("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var d=this.transceivers.find(function(h){return h.track===o});if(d)throw _("InvalidAccessError","Track already exists.");for(var u,l=0;l<this.transceivers.length;l++)!this.transceivers[l].track&&this.transceivers[l].kind===o.kind&&(u=this.transceivers[l]);return u||(u=this._createTransceiver(o.kind)),this._maybeFireNegotiationNeeded(),this.localStreams.indexOf(i)===-1&&this.localStreams.push(i),u.track=o,u.stream=i,u.rtpSender=new t.RTCRtpSender(o,u.dtlsTransport),u.rtpSender},s.prototype.addStream=function(o){var i=this;if(r>=15025)o.getTracks().forEach(function(u){i.addTrack(u,o)});else{var d=o.clone();o.getTracks().forEach(function(u,l){var h=d.getTracks()[l];u.addEventListener("enabled",function(m){h.enabled=m.enabled})}),d.getTracks().forEach(function(u){i.addTrack(u,d)})}},s.prototype.removeTrack=function(o){if(this._isClosed)throw _("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(o instanceof t.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find(function(l){return l.rtpSender===o});if(!i)throw _("InvalidAccessError","Sender was not created by this connection.");var d=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null;var u=this.transceivers.map(function(l){return l.stream});u.indexOf(d)===-1&&this.localStreams.indexOf(d)>-1&&this.localStreams.splice(this.localStreams.indexOf(d),1),this._maybeFireNegotiationNeeded()},s.prototype.removeStream=function(o){var i=this;o.getTracks().forEach(function(d){var u=i.getSenders().find(function(l){return l.track===d});u&&i.removeTrack(u)})},s.prototype.getSenders=function(){return this.transceivers.filter(function(o){return!!o.rtpSender}).map(function(o){return o.rtpSender})},s.prototype.getReceivers=function(){return this.transceivers.filter(function(o){return!!o.rtpReceiver}).map(function(o){return o.rtpReceiver})},s.prototype._createIceGatherer=function(o,i){var d=this;if(i&&o>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var u=new t.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(u,"state",{value:"new",writable:!0}),this.transceivers[o].bufferedCandidateEvents=[],this.transceivers[o].bufferCandidates=function(l){var h=!l.candidate||Object.keys(l.candidate).length===0;u.state=h?"completed":"gathering",d.transceivers[o].bufferedCandidateEvents!==null&&d.transceivers[o].bufferedCandidateEvents.push(l)},u.addEventListener("localcandidate",this.transceivers[o].bufferCandidates),u},s.prototype._gather=function(o,i){var d=this,u=this.transceivers[i].iceGatherer;if(!u.onlocalcandidate){var l=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,u.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),u.onlocalcandidate=function(h){if(!(d.usingBundle&&i>0)){var m=new Event("icecandidate");m.candidate={sdpMid:o,sdpMLineIndex:i};var y=h.candidate,T=!y||Object.keys(y).length===0;if(T)(u.state==="new"||u.state==="gathering")&&(u.state="completed");else{u.state==="new"&&(u.state="gathering"),y.component=1,y.ufrag=u.getLocalParameters().usernameFragment;var v=f.writeCandidate(y);m.candidate=Object.assign(m.candidate,f.parseCandidate(v)),m.candidate.candidate=v,m.candidate.toJSON=function(){return{candidate:m.candidate.candidate,sdpMid:m.candidate.sdpMid,sdpMLineIndex:m.candidate.sdpMLineIndex,usernameFragment:m.candidate.usernameFragment}}}var g=f.getMediaSections(d._localDescription.sdp);T?g[m.candidate.sdpMLineIndex]+=`a=end-of-candidates\r
`:g[m.candidate.sdpMLineIndex]+="a="+m.candidate.candidate+`\r
`,d._localDescription.sdp=f.getDescription(d._localDescription.sdp)+g.join("");var E=d.transceivers.every(function(R){return R.iceGatherer&&R.iceGatherer.state==="completed"});d.iceGatheringState!=="gathering"&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),T||d._dispatchEvent("icecandidate",m),E&&(d._dispatchEvent("icecandidate",new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange())}},t.setTimeout(function(){l.forEach(function(h){u.onlocalcandidate(h)})},0)}},s.prototype._createIceAndDtlsTransports=function(){var o=this,i=new t.RTCIceTransport(null);i.onicestatechange=function(){o._updateIceConnectionState(),o._updateConnectionState()};var d=new t.RTCDtlsTransport(i);return d.ondtlsstatechange=function(){o._updateConnectionState()},d.onerror=function(){Object.defineProperty(d,"state",{value:"failed",writable:!0}),o._updateConnectionState()},{iceTransport:i,dtlsTransport:d}},s.prototype._disposeIceAndDtlsTransports=function(o){var i=this.transceivers[o].iceGatherer;i&&(delete i.onlocalcandidate,delete this.transceivers[o].iceGatherer);var d=this.transceivers[o].iceTransport;d&&(delete d.onicestatechange,delete this.transceivers[o].iceTransport);var u=this.transceivers[o].dtlsTransport;u&&(delete u.ondtlsstatechange,delete u.onerror,delete this.transceivers[o].dtlsTransport)},s.prototype._transceive=function(o,i,d){var u=$(o.localCapabilities,o.remoteCapabilities);i&&o.rtpSender&&(u.encodings=o.sendEncodingParameters,u.rtcp={cname:f.localCName,compound:o.rtcpParameters.compound},o.recvEncodingParameters.length&&(u.rtcp.ssrc=o.recvEncodingParameters[0].ssrc),o.rtpSender.send(u)),d&&o.rtpReceiver&&u.codecs.length>0&&(o.kind==="video"&&o.recvEncodingParameters&&r<15019&&o.recvEncodingParameters.forEach(function(l){delete l.rtx}),o.recvEncodingParameters.length?u.encodings=o.recvEncodingParameters:u.encodings=[{}],u.rtcp={compound:o.rtcpParameters.compound},o.rtcpParameters.cname&&(u.rtcp.cname=o.rtcpParameters.cname),o.sendEncodingParameters.length&&(u.rtcp.ssrc=o.sendEncodingParameters[0].ssrc),o.rtpReceiver.receive(u))},s.prototype.setLocalDescription=function(o){var i=this;if(["offer","answer"].indexOf(o.type)===-1)return Promise.reject(_("TypeError",'Unsupported type "'+o.type+'"'));if(!be("setLocalDescription",o.type,i.signalingState)||i._isClosed)return Promise.reject(_("InvalidStateError","Can not set local "+o.type+" in state "+i.signalingState));var d,u;if(o.type==="offer")d=f.splitSections(o.sdp),u=d.shift(),d.forEach(function(h,m){var y=f.parseRtpParameters(h);i.transceivers[m].localCapabilities=y}),i.transceivers.forEach(function(h,m){i._gather(h.mid,m)});else if(o.type==="answer"){d=f.splitSections(i._remoteDescription.sdp),u=d.shift();var l=f.matchPrefix(u,"a=ice-lite").length>0;d.forEach(function(h,m){var y=i.transceivers[m],T=y.iceGatherer,v=y.iceTransport,g=y.dtlsTransport,E=y.localCapabilities,R=y.remoteCapabilities,S=f.isRejected(h)&&f.matchPrefix(h,"a=bundle-only").length===0;if(!S&&!y.rejected){var k=f.getIceParameters(h,u),b=f.getDtlsParameters(h,u);l&&(b.role="server"),(!i.usingBundle||m===0)&&(i._gather(y.mid,m),v.state==="new"&&v.start(T,k,l?"controlling":"controlled"),g.state==="new"&&g.start(b));var P=$(E,R);i._transceive(y,P.codecs.length>0,!1)}})}return i._localDescription={type:o.type,sdp:o.sdp},o.type==="offer"?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},s.prototype.setRemoteDescription=function(o){var i=this;if(["offer","answer"].indexOf(o.type)===-1)return Promise.reject(_("TypeError",'Unsupported type "'+o.type+'"'));if(!be("setRemoteDescription",o.type,i.signalingState)||i._isClosed)return Promise.reject(_("InvalidStateError","Can not set remote "+o.type+" in state "+i.signalingState));var d={};i.remoteStreams.forEach(function(v){d[v.id]=v});var u=[],l=f.splitSections(o.sdp),h=l.shift(),m=f.matchPrefix(h,"a=ice-lite").length>0,y=f.matchPrefix(h,"a=group:BUNDLE ").length>0;i.usingBundle=y;var T=f.matchPrefix(h,"a=ice-options:")[0];return T?i.canTrickleIceCandidates=T.substr(14).split(" ").indexOf("trickle")>=0:i.canTrickleIceCandidates=!1,l.forEach(function(v,g){var E=f.splitLines(v),R=f.getKind(v),S=f.isRejected(v)&&f.matchPrefix(v,"a=bundle-only").length===0,k=E[0].substr(2).split(" ")[2],b=f.getDirection(v,h),P=f.parseMsid(v),he=f.getMid(v)||f.generateIdentifier();if(S||R==="application"&&(k==="DTLS/SCTP"||k==="UDP/DTLS/SCTP")){i.transceivers[g]={mid:he,kind:R,protocol:k,rejected:!0};return}!S&&i.transceivers[g]&&i.transceivers[g].rejected&&(i.transceivers[g]=i._createTransceiver(R,!0));var C,me,U,Y,D,Z,Q,B,I,fe=f.parseRtpParameters(v),ve,ee;S||(ve=f.getIceParameters(v,h),ee=f.getDtlsParameters(v,h),ee.role="client"),Q=f.parseRtpEncodingParameters(v);var ge=f.parseRtcpParameters(v),ye=f.matchPrefix(v,"a=end-of-candidates",h).length>0,L=f.matchPrefix(v,"a=candidate:").map(function(w){return f.parseCandidate(w)}).filter(function(w){return w.component===1});if((o.type==="offer"||o.type==="answer")&&!S&&y&&g>0&&i.transceivers[g]&&(i._disposeIceAndDtlsTransports(g),i.transceivers[g].iceGatherer=i.transceivers[0].iceGatherer,i.transceivers[g].iceTransport=i.transceivers[0].iceTransport,i.transceivers[g].dtlsTransport=i.transceivers[0].dtlsTransport,i.transceivers[g].rtpSender&&i.transceivers[g].rtpSender.setTransport(i.transceivers[0].dtlsTransport),i.transceivers[g].rtpReceiver&&i.transceivers[g].rtpReceiver.setTransport(i.transceivers[0].dtlsTransport)),o.type==="offer"&&!S){C=i.transceivers[g]||i._createTransceiver(R),C.mid=he,C.iceGatherer||(C.iceGatherer=i._createIceGatherer(g,y)),L.length&&C.iceTransport.state==="new"&&(ye&&(!y||g===0)?C.iceTransport.setRemoteCandidates(L):L.forEach(function(w){re(C.iceTransport,w)})),B=t.RTCRtpReceiver.getCapabilities(R),r<15019&&(B.codecs=B.codecs.filter(function(w){return w.name!=="rtx"})),Z=C.sendEncodingParameters||[{ssrc:(2*g+2)*1001}];var te=!1;if(b==="sendrecv"||b==="sendonly"){if(te=!C.rtpReceiver,D=C.rtpReceiver||new t.RTCRtpReceiver(C.dtlsTransport,R),te){var j;I=D.track,P&&P.stream==="-"||(P?(d[P.stream]||(d[P.stream]=new t.MediaStream,Object.defineProperty(d[P.stream],"id",{get:function(){return P.stream}})),Object.defineProperty(I,"id",{get:function(){return P.track}}),j=d[P.stream]):(d.default||(d.default=new t.MediaStream),j=d.default)),j&&(e(I,j),C.associatedRemoteMediaStreams.push(j)),u.push([I,D,j])}}else C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach(function(w){var Ce=w.getTracks().find(function(vt){return vt.id===C.rtpReceiver.track.id});Ce&&n(Ce,w)}),C.associatedRemoteMediaStreams=[]);C.localCapabilities=B,C.remoteCapabilities=fe,C.rtpReceiver=D,C.rtcpParameters=ge,C.sendEncodingParameters=Z,C.recvEncodingParameters=Q,i._transceive(i.transceivers[g],!1,te)}else if(o.type==="answer"&&!S){C=i.transceivers[g],me=C.iceGatherer,U=C.iceTransport,Y=C.dtlsTransport,D=C.rtpReceiver,Z=C.sendEncodingParameters,B=C.localCapabilities,i.transceivers[g].recvEncodingParameters=Q,i.transceivers[g].remoteCapabilities=fe,i.transceivers[g].rtcpParameters=ge,L.length&&U.state==="new"&&((m||ye)&&(!y||g===0)?U.setRemoteCandidates(L):L.forEach(function(w){re(C.iceTransport,w)})),(!y||g===0)&&(U.state==="new"&&U.start(me,ve,"controlling"),Y.state==="new"&&Y.start(ee));var mt=$(C.localCapabilities,C.remoteCapabilities),ft=mt.codecs.filter(function(w){return w.name.toLowerCase()==="rtx"}).length;!ft&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,i._transceive(C,b==="sendrecv"||b==="recvonly",b==="sendrecv"||b==="sendonly"),D&&(b==="sendrecv"||b==="sendonly")?(I=D.track,P?(d[P.stream]||(d[P.stream]=new t.MediaStream),e(I,d[P.stream]),u.push([I,D,d[P.stream]])):(d.default||(d.default=new t.MediaStream),e(I,d.default),u.push([I,D,d.default]))):delete C.rtpReceiver}}),i._dtlsRole===void 0&&(i._dtlsRole=o.type==="offer"?"active":"passive"),i._remoteDescription={type:o.type,sdp:o.sdp},o.type==="offer"?i._updateSignalingState("have-remote-offer"):i._updateSignalingState("stable"),Object.keys(d).forEach(function(v){var g=d[v];if(g.getTracks().length){if(i.remoteStreams.indexOf(g)===-1){i.remoteStreams.push(g);var E=new Event("addstream");E.stream=g,t.setTimeout(function(){i._dispatchEvent("addstream",E)})}u.forEach(function(R){var S=R[0],k=R[1];g.id===R[2].id&&a(i,S,k,[g])})}}),u.forEach(function(v){v[2]||a(i,v[0],v[1],[])}),t.setTimeout(function(){i&&i.transceivers&&i.transceivers.forEach(function(v){v.iceTransport&&v.iceTransport.state==="new"&&v.iceTransport.getRemoteCandidates().length>0&&v.iceTransport.addRemoteCandidate({})})},4e3),Promise.resolve()},s.prototype.close=function(){this.transceivers.forEach(function(o){o.iceTransport&&o.iceTransport.stop(),o.dtlsTransport&&o.dtlsTransport.stop(),o.rtpSender&&o.rtpSender.stop(),o.rtpReceiver&&o.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},s.prototype._updateSignalingState=function(o){this.signalingState=o;var i=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",i)},s.prototype._maybeFireNegotiationNeeded=function(){var o=this;this.signalingState!=="stable"||this.needNegotiation===!0||(this.needNegotiation=!0,t.setTimeout(function(){if(o.needNegotiation){o.needNegotiation=!1;var i=new Event("negotiationneeded");o._dispatchEvent("negotiationneeded",i)}},0))},s.prototype._updateIceConnectionState=function(){var o,i={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&!u.rejected&&i[u.iceTransport.state]++}),o="new",i.failed>0?o="failed":i.checking>0?o="checking":i.disconnected>0?o="disconnected":i.new>0?o="new":i.connected>0?o="connected":i.completed>0&&(o="completed"),o!==this.iceConnectionState){this.iceConnectionState=o;var d=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",d)}},s.prototype._updateConnectionState=function(){var o,i={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(u){u.iceTransport&&u.dtlsTransport&&!u.rejected&&(i[u.iceTransport.state]++,i[u.dtlsTransport.state]++)}),i.connected+=i.completed,o="new",i.failed>0?o="failed":i.connecting>0?o="connecting":i.disconnected>0?o="disconnected":i.new>0?o="new":i.connected>0&&(o="connected"),o!==this.connectionState){this.connectionState=o;var d=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",d)}},s.prototype.createOffer=function(){var o=this;if(o._isClosed)return Promise.reject(_("InvalidStateError","Can not call createOffer after close"));var i=o.transceivers.filter(function(m){return m.kind==="audio"}).length,d=o.transceivers.filter(function(m){return m.kind==="video"}).length,u=arguments[0];if(u){if(u.mandatory||u.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");u.offerToReceiveAudio!==void 0&&(u.offerToReceiveAudio===!0?i=1:u.offerToReceiveAudio===!1?i=0:i=u.offerToReceiveAudio),u.offerToReceiveVideo!==void 0&&(u.offerToReceiveVideo===!0?d=1:u.offerToReceiveVideo===!1?d=0:d=u.offerToReceiveVideo)}for(o.transceivers.forEach(function(m){m.kind==="audio"?(i--,i<0&&(m.wantReceive=!1)):m.kind==="video"&&(d--,d<0&&(m.wantReceive=!1))});i>0||d>0;)i>0&&(o._createTransceiver("audio"),i--),d>0&&(o._createTransceiver("video"),d--);var l=f.writeSessionBoilerplate(o._sdpSessionId,o._sdpSessionVersion++);o.transceivers.forEach(function(m,y){var T=m.track,v=m.kind,g=m.mid||f.generateIdentifier();m.mid=g,m.iceGatherer||(m.iceGatherer=o._createIceGatherer(y,o.usingBundle));var E=t.RTCRtpSender.getCapabilities(v);r<15019&&(E.codecs=E.codecs.filter(function(S){return S.name!=="rtx"})),E.codecs.forEach(function(S){S.name==="H264"&&S.parameters["level-asymmetry-allowed"]===void 0&&(S.parameters["level-asymmetry-allowed"]="1"),m.remoteCapabilities&&m.remoteCapabilities.codecs&&m.remoteCapabilities.codecs.forEach(function(k){S.name.toLowerCase()===k.name.toLowerCase()&&S.clockRate===k.clockRate&&(S.preferredPayloadType=k.payloadType)})}),E.headerExtensions.forEach(function(S){var k=m.remoteCapabilities&&m.remoteCapabilities.headerExtensions||[];k.forEach(function(b){S.uri===b.uri&&(S.id=b.id)})});var R=m.sendEncodingParameters||[{ssrc:(2*y+1)*1001}];T&&r>=15019&&v==="video"&&!R[0].rtx&&(R[0].rtx={ssrc:R[0].ssrc+1}),m.wantReceive&&(m.rtpReceiver=new t.RTCRtpReceiver(m.dtlsTransport,v)),m.localCapabilities=E,m.sendEncodingParameters=R}),o._config.bundlePolicy!=="max-compat"&&(l+="a=group:BUNDLE "+o.transceivers.map(function(m){return m.mid}).join(" ")+`\r
`),l+=`a=ice-options:trickle\r
`,o.transceivers.forEach(function(m,y){l+=_e(m,m.localCapabilities,"offer",m.stream,o._dtlsRole),l+=`a=rtcp-rsize\r
`,m.iceGatherer&&o.iceGatheringState!=="new"&&(y===0||!o.usingBundle)&&(m.iceGatherer.getLocalCandidates().forEach(function(T){T.component=1,l+="a="+f.writeCandidate(T)+`\r
`}),m.iceGatherer.state==="completed"&&(l+=`a=end-of-candidates\r
`))});var h=new t.RTCSessionDescription({type:"offer",sdp:l});return Promise.resolve(h)},s.prototype.createAnswer=function(){var o=this;if(o._isClosed)return Promise.reject(_("InvalidStateError","Can not call createAnswer after close"));if(!(o.signalingState==="have-remote-offer"||o.signalingState==="have-local-pranswer"))return Promise.reject(_("InvalidStateError","Can not call createAnswer in signalingState "+o.signalingState));var i=f.writeSessionBoilerplate(o._sdpSessionId,o._sdpSessionVersion++);o.usingBundle&&(i+="a=group:BUNDLE "+o.transceivers.map(function(l){return l.mid}).join(" ")+`\r
`),i+=`a=ice-options:trickle\r
`;var d=f.getMediaSections(o._remoteDescription.sdp).length;o.transceivers.forEach(function(l,h){if(!(h+1>d)){if(l.rejected){l.kind==="application"?l.protocol==="DTLS/SCTP"?i+=`m=application 0 DTLS/SCTP 5000\r
`:i+="m=application 0 "+l.protocol+` webrtc-datachannel\r
`:l.kind==="audio"?i+=`m=audio 0 UDP/TLS/RTP/SAVPF 0\r
a=rtpmap:0 PCMU/8000\r
`:l.kind==="video"&&(i+=`m=video 0 UDP/TLS/RTP/SAVPF 120\r
a=rtpmap:120 VP8/90000\r
`),i+=`c=IN IP4 0.0.0.0\r
a=inactive\r
a=mid:`+l.mid+`\r
`;return}if(l.stream){var m;l.kind==="audio"?m=l.stream.getAudioTracks()[0]:l.kind==="video"&&(m=l.stream.getVideoTracks()[0]),m&&r>=15019&&l.kind==="video"&&!l.sendEncodingParameters[0].rtx&&(l.sendEncodingParameters[0].rtx={ssrc:l.sendEncodingParameters[0].ssrc+1})}var y=$(l.localCapabilities,l.remoteCapabilities),T=y.codecs.filter(function(v){return v.name.toLowerCase()==="rtx"}).length;!T&&l.sendEncodingParameters[0].rtx&&delete l.sendEncodingParameters[0].rtx,i+=_e(l,y,"answer",l.stream,o._dtlsRole),l.rtcpParameters&&l.rtcpParameters.reducedSize&&(i+=`a=rtcp-rsize\r
`)}});var u=new t.RTCSessionDescription({type:"answer",sdp:i});return Promise.resolve(u)},s.prototype.addIceCandidate=function(o){var i=this,d;return o&&!(o.sdpMLineIndex!==void 0||o.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(u,l){if(i._remoteDescription)if(!o||o.candidate==="")for(var h=0;h<i.transceivers.length&&!(!i.transceivers[h].rejected&&(i.transceivers[h].iceTransport.addRemoteCandidate({}),d=f.getMediaSections(i._remoteDescription.sdp),d[h]+=`a=end-of-candidates\r
`,i._remoteDescription.sdp=f.getDescription(i._remoteDescription.sdp)+d.join(""),i.usingBundle));h++);else{var m=o.sdpMLineIndex;if(o.sdpMid){for(var y=0;y<i.transceivers.length;y++)if(i.transceivers[y].mid===o.sdpMid){m=y;break}}var T=i.transceivers[m];if(T){if(T.rejected)return u();var v=Object.keys(o.candidate).length>0?f.parseCandidate(o.candidate):{};if(v.protocol==="tcp"&&(v.port===0||v.port===9)||v.component&&v.component!==1)return u();if((m===0||m>0&&T.iceTransport!==i.transceivers[0].iceTransport)&&!re(T.iceTransport,v))return l(_("OperationError","Can not add ICE candidate"));var g=o.candidate.trim();g.indexOf("a=")===0&&(g=g.substr(2)),d=f.getMediaSections(i._remoteDescription.sdp),d[m]+="a="+(v.type?g:"end-of-candidates")+`\r
`,i._remoteDescription.sdp=f.getDescription(i._remoteDescription.sdp)+d.join("")}else return l(_("OperationError","Can not add ICE candidate"))}else return l(_("InvalidStateError","Can not add ICE candidate without a remote description"));u()})},s.prototype.getStats=function(o){if(o&&o instanceof t.MediaStreamTrack){var i=null;if(this.transceivers.forEach(function(u){u.rtpSender&&u.rtpSender.track===o?i=u.rtpSender:u.rtpReceiver&&u.rtpReceiver.track===o&&(i=u.rtpReceiver)}),!i)throw _("InvalidAccessError","Invalid selector.");return i.getStats()}var d=[];return this.transceivers.forEach(function(u){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(l){u[l]&&d.push(u[l].getStats())})}),Promise.all(d).then(function(u){var l=new Map;return u.forEach(function(h){h.forEach(function(m){l.set(m.id,m)})}),l})};var c=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];c.forEach(function(o){var i=t[o];if(i&&i.prototype&&i.prototype.getStats){var d=i.prototype.getStats;i.prototype.getStats=function(){return d.apply(this).then(function(u){var l=new Map;return Object.keys(u).forEach(function(h){u[h].type=wt(u[h]),l.set(h,u[h])}),l})}}});var p=["createOffer","createAnswer"];return p.forEach(function(o){var i=s.prototype[o];s.prototype[o]=function(){var d=arguments;return typeof d[0]=="function"||typeof d[1]=="function"?i.apply(this,[arguments[2]]).then(function(u){typeof d[0]=="function"&&d[0].apply(null,[u])},function(u){typeof d[1]=="function"&&d[1].apply(null,[u])}):i.apply(this,arguments)}}),p=["setLocalDescription","setRemoteDescription","addIceCandidate"],p.forEach(function(o){var i=s.prototype[o];s.prototype[o]=function(){var d=arguments;return typeof d[1]=="function"||typeof d[2]=="function"?i.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)},function(u){typeof d[2]=="function"&&d[2].apply(null,[u])}):i.apply(this,arguments)}}),["getStats"].forEach(function(o){var i=s.prototype[o];s.prototype[o]=function(){var d=arguments;return typeof d[1]=="function"?i.apply(this,arguments).then(function(){typeof d[1]=="function"&&d[1].apply(null)}):i.apply(this,arguments)}}),s};function Ue(t){const r=t&&t.navigator,e=function(a){return{name:{PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:a.message,constraint:a.constraint,toString(){return this.name}}},n=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(a){return n(a).catch(s=>Promise.reject(e(s)))}}function Be(t){"getDisplayMedia"in t.navigator&&t.navigator.mediaDevices&&(t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||(t.navigator.mediaDevices.getDisplayMedia=t.navigator.getDisplayMedia.bind(t.navigator)))}function ae(t,r){if(t.RTCIceGatherer&&(t.RTCIceCandidate||(t.RTCIceCandidate=function(n){return n}),t.RTCSessionDescription||(t.RTCSessionDescription=function(n){return n}),r.version<15025)){const n=Object.getOwnPropertyDescriptor(t.MediaStreamTrack.prototype,"enabled");Object.defineProperty(t.MediaStreamTrack.prototype,"enabled",{set(a){n.set.call(this,a);const s=new Event("enabled");s.enabled=a,this.dispatchEvent(s)}})}t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)&&Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=new t.RTCDtmfSender(this):this.track.kind==="video"&&(this._dtmf=null)),this._dtmf}}),t.RTCDtmfSender&&!t.RTCDTMFSender&&(t.RTCDTMFSender=t.RTCDtmfSender);const e=Dt(t,r.version);t.RTCPeerConnection=function(n){return n&&n.iceServers&&(n.iceServers=_t(n.iceServers,r.version),n.iceServers),new e(n)},t.RTCPeerConnection.prototype=e.prototype}function ze(t){t.RTCRtpSender&&!("replaceTrack"in t.RTCRtpSender.prototype)&&(t.RTCRtpSender.prototype.replaceTrack=t.RTCRtpSender.prototype.setTrack)}var we=Object.freeze({__proto__:null,shimPeerConnection:ae,shimReplaceTrack:ze,shimGetUserMedia:Ue,shimGetDisplayMedia:Be});function We(t,r){const e=t&&t.navigator,n=t&&t.MediaStreamTrack;if(e.getUserMedia=function(a,s,c){e.mediaDevices.getUserMedia(a).then(s,c)},!(r.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){const a=function(c,p,o){p in c&&!(o in c)&&(c[o]=c[p],delete c[p])},s=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if(e.mediaDevices.getUserMedia=function(c){return typeof c=="object"&&typeof c.audio=="object"&&(c=JSON.parse(JSON.stringify(c)),a(c.audio,"autoGainControl","mozAutoGainControl"),a(c.audio,"noiseSuppression","mozNoiseSuppression")),s(c)},n&&n.prototype.getSettings){const c=n.prototype.getSettings;n.prototype.getSettings=function(){const p=c.apply(this,arguments);return a(p,"mozAutoGainControl","autoGainControl"),a(p,"mozNoiseSuppression","noiseSuppression"),p}}if(n&&n.prototype.applyConstraints){const c=n.prototype.applyConstraints;n.prototype.applyConstraints=function(p){return this.kind==="audio"&&typeof p=="object"&&(p=JSON.parse(JSON.stringify(p)),a(p,"autoGainControl","mozAutoGainControl"),a(p,"noiseSuppression","mozNoiseSuppression")),c.apply(this,[p])}}}}function It(t,r){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(e){if(!(e&&e.video)){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return e.video===!0?e.video={mediaSource:r}:e.video.mediaSource=r,t.navigator.mediaDevices.getUserMedia(e)})}function Je(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function se(t,r){if(typeof t!="object"||!(t.RTCPeerConnection||t.mozRTCPeerConnection))return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),r.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){const s=t.RTCPeerConnection.prototype[a],c={[a](){return arguments[0]=new(a==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};t.RTCPeerConnection.prototype[a]=c[a]});const e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[a,s,c]=arguments;return n.apply(this,[a||null]).then(p=>{if(r.version<53&&!s)try{p.forEach(o=>{o.type=e[o.type]||o.type})}catch(o){if(o.name!=="TypeError")throw o;p.forEach((i,d)=>{p.set(d,Object.assign({},i,{type:e[i.type]||i.type}))})}return p}).then(s,c)}}function $e(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender)||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const r=t.RTCPeerConnection.prototype.getSenders;r&&(t.RTCPeerConnection.prototype.getSenders=function(){const n=r.apply(this,[]);return n.forEach(a=>a._pc=this),n});const e=t.RTCPeerConnection.prototype.addTrack;e&&(t.RTCPeerConnection.prototype.addTrack=function(){const n=e.apply(this,arguments);return n._pc=this,n}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function He(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender)||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const r=t.RTCPeerConnection.prototype.getReceivers;r&&(t.RTCPeerConnection.prototype.getReceivers=function(){const e=r.apply(this,[]);return e.forEach(n=>n._pc=this),e}),F(t,"track",e=>(e.receiver._pc=e.srcElement,e)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Ke(t){!t.RTCPeerConnection||"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(r){this.getSenders().forEach(e=>{e.track&&r.getTracks().includes(e.track)&&this.removeTrack(e)})})}function Xe(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function qe(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const r=t.RTCPeerConnection.prototype.addTransceiver;r&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],n=e&&"sendEncodings"in e;n&&e.sendEncodings.forEach(s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const a=r.apply(this,arguments);if(n){const{sender:s}=a,c=s.getParameters();(!("encodings"in c)||c.encodings.length===1&&Object.keys(c.encodings[0]).length===0)&&(c.encodings=e.sendEncodings,s.sendEncodings=e.sendEncodings,this.setParametersPromises.push(s.setParameters(c).then(()=>{delete s.sendEncodings}).catch(()=>{delete s.sendEncodings})))}return a})}function Ye(t){if(!(typeof t=="object"&&t.RTCRtpSender))return;const r=t.RTCRtpSender.prototype.getParameters;r&&(t.RTCRtpSender.prototype.getParameters=function(){const e=r.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Ze(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const r=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>r.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):r.apply(this,arguments)}}function Qe(t){if(!(typeof t=="object"&&t.RTCPeerConnection))return;const r=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>r.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):r.apply(this,arguments)}}var ke=Object.freeze({__proto__:null,shimOnTrack:Je,shimPeerConnection:se,shimSenderGetStats:$e,shimReceiverGetStats:He,shimRemoveStream:Ke,shimRTCDataChannel:Xe,shimAddTransceiver:qe,shimGetParameters:Ye,shimCreateOffer:Ze,shimCreateAnswer:Qe,shimGetUserMedia:We,shimGetDisplayMedia:It});function et(t){if(!(typeof t!="object"||!t.RTCPeerConnection)){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(n=>r.call(this,n,e)),e.getVideoTracks().forEach(n=>r.call(this,n,e))},t.RTCPeerConnection.prototype.addTrack=function(e,...n){return n&&n.forEach(a=>{this._localStreams?this._localStreams.includes(a)||this._localStreams.push(a):this._localStreams=[a]}),r.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(r){this._localStreams||(this._localStreams=[]);const e=this._localStreams.indexOf(r);if(e===-1)return;this._localStreams.splice(e,1);const n=r.getTracks();this.getSenders().forEach(a=>{n.includes(a.track)&&this.removeTrack(a)})})}}function tt(t){if(!(typeof t!="object"||!t.RTCPeerConnection)&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=n=>{n.streams.forEach(a=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(a))return;this._remoteStreams.push(a);const s=new Event("addstream");s.stream=a,this.dispatchEvent(s)})})}});const r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(a=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(a)>=0)return;e._remoteStreams.push(a);const s=new Event("addstream");s.stream=a,e.dispatchEvent(s)})}),r.apply(e,arguments)}}}function rt(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const r=t.RTCPeerConnection.prototype,e=r.createOffer,n=r.createAnswer,a=r.setLocalDescription,s=r.setRemoteDescription,c=r.addIceCandidate;r.createOffer=function(o,i){const d=arguments.length>=2?arguments[2]:arguments[0],u=e.apply(this,[d]);return i?(u.then(o,i),Promise.resolve()):u},r.createAnswer=function(o,i){const d=arguments.length>=2?arguments[2]:arguments[0],u=n.apply(this,[d]);return i?(u.then(o,i),Promise.resolve()):u};let p=function(o,i,d){const u=a.apply(this,[o]);return d?(u.then(i,d),Promise.resolve()):u};r.setLocalDescription=p,p=function(o,i,d){const u=s.apply(this,[o]);return d?(u.then(i,d),Promise.resolve()):u},r.setRemoteDescription=p,p=function(o,i,d){const u=c.apply(this,[o]);return d?(u.then(i,d),Promise.resolve()):u},r.addIceCandidate=p}function nt(t){const r=t&&t.navigator;if(r.mediaDevices&&r.mediaDevices.getUserMedia){const e=r.mediaDevices,n=e.getUserMedia.bind(e);r.mediaDevices.getUserMedia=a=>n(it(a))}!r.getUserMedia&&r.mediaDevices&&r.mediaDevices.getUserMedia&&(r.getUserMedia=function(e,n,a){r.mediaDevices.getUserMedia(e).then(n,a)}.bind(r))}function it(t){return t&&t.video!==void 0?Object.assign({},t,{video:Oe(t.video)}):t}function ot(t){if(!t.RTCPeerConnection)return;const r=t.RTCPeerConnection;t.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const a=[];for(let s=0;s<e.iceServers.length;s++){let c=e.iceServers[s];!c.hasOwnProperty("urls")&&c.hasOwnProperty("url")?(c=JSON.parse(JSON.stringify(c)),c.urls=c.url,delete c.url,a.push(c)):a.push(e.iceServers[s])}e.iceServers=a}return new r(e,n)},t.RTCPeerConnection.prototype=r.prototype,"generateCertificate"in r&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get(){return r.generateCertificate}})}function at(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function st(t){const r=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(e){if(e){typeof e.offerToReceiveAudio<"u"&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const n=this.getTransceivers().find(s=>s.receiver.track.kind==="audio");e.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):e.offerToReceiveAudio===!0&&!n&&this.addTransceiver("audio"),typeof e.offerToReceiveVideo<"u"&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const a=this.getTransceivers().find(s=>s.receiver.track.kind==="video");e.offerToReceiveVideo===!1&&a?a.direction==="sendrecv"?a.setDirection?a.setDirection("sendonly"):a.direction="sendonly":a.direction==="recvonly"&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive"):e.offerToReceiveVideo===!0&&!a&&this.addTransceiver("video")}return r.apply(this,arguments)}}function ct(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var De=Object.freeze({__proto__:null,shimLocalStreamsAPI:et,shimRemoteStreamsAPI:tt,shimCallbacksAPI:rt,shimGetUserMedia:nt,shimConstraints:it,shimRTCIceServerUrls:ot,shimTrackEventTransceiver:at,shimCreateOfferLegacy:st,shimAudioContext:ct});function K(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const r=t.RTCIceCandidate;t.RTCIceCandidate=function(e){if(typeof e=="object"&&e.candidate&&e.candidate.indexOf("a=")===0&&(e=JSON.parse(JSON.stringify(e)),e.candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new r(e),a=f.parseCandidate(e.candidate),s=Object.assign(n,a);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new r(e)},t.RTCIceCandidate.prototype=r.prototype,F(t,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"}),e))}function W(t,r){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const e=function(p){if(!p||!p.sdp)return!1;const o=f.splitSections(p.sdp);return o.shift(),o.some(i=>{const d=f.parseMLine(i);return d&&d.kind==="application"&&d.protocol.indexOf("SCTP")!==-1})},n=function(p){const o=p.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(o===null||o.length<2)return-1;const i=parseInt(o[1],10);return i!==i?-1:i},a=function(p){let o=65536;return r.browser==="firefox"&&(r.version<57?p===-1?o=16384:o=2147483637:r.version<60?o=r.version===57?65535:65536:o=2147483637),o},s=function(p,o){let i=65536;r.browser==="firefox"&&r.version===57&&(i=65535);const d=f.matchPrefix(p.sdp,"a=max-message-size:");return d.length>0?i=parseInt(d[0].substr(19),10):r.browser==="firefox"&&o!==-1&&(i=2147483637),i},c=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,r.browser==="chrome"&&r.version>=76){const{sdpSemantics:p}=this.getConfiguration();p==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){const p=n(arguments[0]),o=a(p),i=s(arguments[0],p);let d;o===0&&i===0?d=Number.POSITIVE_INFINITY:o===0||i===0?d=Math.max(o,i):d=Math.min(o,i);const u={};Object.defineProperty(u,"maxMessageSize",{get(){return d}}),this._sctp=u}return c.apply(this,arguments)}}function J(t){if(!(t.RTCPeerConnection&&"createDataChannel"in t.RTCPeerConnection.prototype))return;function r(n,a){const s=n.send;n.send=function(){const c=arguments[0],p=c.length||c.size||c.byteLength;if(n.readyState==="open"&&a.sctp&&p>a.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+a.sctp.maxMessageSize+" bytes)");return s.apply(n,arguments)}}const e=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const n=e.apply(this,arguments);return r(n,this),n},F(t,"datachannel",n=>(r(n.channel,n.target),n))}function ce(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const r=t.RTCPeerConnection.prototype;Object.defineProperty(r,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(r,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const n=r[e];r[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=a=>{const s=a.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const c=new Event("connectionstatechange",a);s.dispatchEvent(c)}return a},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function de(t,r){if(!t.RTCPeerConnection||r.browser==="chrome"&&r.version>=71||r.browser==="safari"&&r.version>=605)return;const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const a=n.sdp.split(`
`).filter(s=>s.trim()!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&n instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:n.type,sdp:a}):n.sdp=a}return e.apply(this,arguments)}}function X(t,r){if(!(t.RTCPeerConnection&&t.RTCPeerConnection.prototype))return;const e=t.RTCPeerConnection.prototype.addIceCandidate;!e||e.length===0||(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(r.browser==="chrome"&&r.version<78||r.browser==="firefox"&&r.version<68||r.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}var Ot=Object.freeze({__proto__:null,shimRTCIceCandidate:K,shimMaxMessageSize:W,shimSendThrowTypeError:J,shimConnectionState:ce,removeExtmapAllowMixed:de,shimAddIceCandidateNullOrEmpty:X});function xt({window:t}={},r={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const e=Et(t),n={browserDetails:e,commonShim:Ot,extractVersion:z,disableLog:Tt,disableWarnings:St};switch(e.browser){case"chrome":if(!Pe||!oe||!r.shimChrome||e.version===null)return n;n.browserShim=Pe,X(t,e),xe(t,e),Me(t),oe(t,e),Ae(t),Fe(t,e),Le(t),je(t),Ne(t),Ve(t,e),K(t),ce(t),W(t,e),J(t),de(t,e);break;case"firefox":if(!ke||!se||!r.shimFirefox)return n;n.browserShim=ke,X(t,e),We(t,e),se(t,e),Je(t),Ke(t),$e(t),He(t),Xe(t),qe(t),Ye(t),Ze(t),Qe(t),K(t),ce(t),W(t,e),J(t);break;case"edge":if(!we||!ae||!r.shimEdge)return n;n.browserShim=we,Ue(t),Be(t),ae(t,e),ze(t),W(t,e),J(t);break;case"safari":if(!De||!r.shimSafari)return n;n.browserShim=De,X(t,e),ot(t),st(t),rt(t),et(t),tt(t),at(t),nt(t),ct(t),K(t),W(t,e),J(t),de(t,e);break}return n}xt({window:typeof window>"u"?void 0:window});class q{constructor(r){if(!Object.values(O).some(e=>e===r))throw new TypeError("Invalid source.");this.source=r,this.deviceId=void 0}}class pe{constructor(r){if(!Object.values(A).some(e=>e===r))throw new TypeError("Invalid source.");this.source=r,this.deviceId=void 0,this.resolution=void 0,this.frameRate=void 0}}class dt{constructor(r=!1,e=!1){this.audio=r,this.video=e}}function H(t){return typeof t.video=="object"&&t.video.source===A.SCREENCAST}class pt{static createMediaStream(r){if(typeof r!="object"||!r.audio&&!r.video)return Promise.reject(new TypeError("Invalid constrains"));if(!H(r)&&typeof r.audio=="object"&&r.audio.source===O.SCREENCAST)return Promise.reject(new TypeError("Cannot share screen without video."));if(H(r)&&!gt()&&!Te())return Promise.reject(new TypeError("Screen sharing only supports Chrome and Firefox."));if(H(r)&&typeof r.audio=="object"&&r.audio.source!==O.SCREENCAST)return Promise.reject(new TypeError("Cannot capture video from screen cast while capture audio from other source."));if(!r.audio&&!r.video)return Promise.reject(new TypeError("At least one of audio and video must be requested."));const e=Object.create({});return typeof r.audio=="object"&&r.audio.source===O.MIC?(e.audio=Object.create({}),yt()?e.audio.deviceId=r.audio.deviceId:e.audio.deviceId={exact:r.audio.deviceId}):r.audio.source===O.SCREENCAST?e.audio=!0:e.audio=r.audio,typeof r.video=="object"?(e.video=Object.create({}),typeof r.video.frameRate=="number"&&(e.video.frameRate=r.video.frameRate),r.video.resolution&&r.video.resolution.width&&r.video.resolution.height&&(r.video.source===A.SCREENCAST?(e.video.width=r.video.resolution.width,e.video.height=r.video.resolution.height):(e.video.width=Object.create({}),e.video.width.exact=r.video.resolution.width,e.video.height=Object.create({}),e.video.height.exact=r.video.resolution.height)),typeof r.video.deviceId=="string"&&(e.video.deviceId={exact:r.video.deviceId}),Te()&&r.video.source===A.SCREENCAST&&(e.video.mediaSource="screen")):e.video=r.video,H(r)?navigator.mediaDevices.getDisplayMedia(e):navigator.mediaDevices.getUserMedia(e)}}Object.freeze({__proto__:null,AudioTrackConstraints:q,VideoTrackConstraints:pe,StreamConstraints:dt,MediaStreamFactory:pt,AudioSourceInfo:O,VideoSourceInfo:A,TrackKind:Ct,Resolution:Ie});let ue,le;function Mt(){ue=console.log,le=console.error}function M(t,...r){ue&&ue(t,...r)}function N(t,...r){le&&le(t,...r)}class At{constructor(r){this.listener={},this.type=r|""}on(r,e){return this.listener[r]||(this.listener[r]=[]),this.listener[r].push(e),!0}off(r,e){if(this.listener[r]){var n=this.listener[r].indexOf(e);return n>-1&&this.listener[r].splice(n,1),!0}return!1}offAll(){this.listener={}}dispatch(r,e){return this.listener[r]?(this.listener[r].map(n=>{n.apply(null,[e])}),!0):!1}}class Lt extends At{constructor(r){super("RTCPusherPlayer"),this.TAG="[RTCPusherPlayer]";let e={element:"",debug:!1,zlmsdpUrl:"",simulcast:!1,useCamera:!0,audioEnable:!0,videoEnable:!0,recvOnly:!1,resolution:{w:0,h:0}};this.options=Object.assign({},e,r),this.options.debug&&Mt(),this.e={onicecandidate:this._onIceCandidate.bind(this),ontrack:this._onTrack.bind(this),onicecandidateerror:this._onIceCandidateError.bind(this),onconnectionstatechange:this._onconnectionstatechange.bind(this)},this._remoteStream=null,this._localStream=null,this.pc=new RTCPeerConnection(null),this.pc.onicecandidate=this.e.onicecandidate,this.pc.onicecandidateerror=this.e.onicecandidateerror,this.pc.ontrack=this.e.ontrack,this.pc.onconnectionstatechange=this.e.onconnectionstatechange,!this.options.recvOnly&&(this.options.audioEnable||this.options.videoEnable)?this.start():this.receive()}receive(){const r={direction:"recvonly",sendEncodings:[]},e={direction:"recvonly",sendEncodings:[]};this.pc.addTransceiver("audio",r),this.pc.addTransceiver("video",e),this.pc.createOffer().then(n=>{M(this.TAG,"offer:",n.sdp),this.pc.setLocalDescription(n).then(()=>{ne({method:"post",url:this.options.zlmsdpUrl,responseType:"json",data:n.sdp,headers:{"Content-Type":"text/plain;charset=utf-8"}}).then(a=>{let s=a.data;if(s.code!=0){this.dispatch(x.WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED,s);return}let c={};c.sdp=s.sdp,c.type="answer",M(this.TAG,"answer:",s.sdp),this.pc.setRemoteDescription(c).then(()=>{M(this.TAG,"set remote sucess")}).catch(p=>{N(this.TAG,p)})})})}).catch(n=>{N(this.TAG,n)})}start(){let r=!1,e=!1;this.options.useCamera?(this.options.videoEnable&&(r=new pe(A.CAMERA)),this.options.audioEnable&&(e=new q(O.MIC))):this.options.videoEnable?(r=new pe(A.SCREENCAST),this.options.audioEnable&&(e=new q(O.SCREENCAST))):this.options.audioEnable?e=new q(O.MIC):N(this.TAG,"error paramter"),this.options.resolution.w!=0&&this.options.resolution.h!=0&&typeof r=="object"&&(r.resolution=new Ie(this.options.resolution.w,this.options.resolution.h)),pt.createMediaStream(new dt(e,r)).then(n=>{this._localStream=n,this.dispatch(x.WEBRTC_ON_LOCAL_STREAM,n);const a={direction:"sendrecv",sendEncodings:[]},s={direction:"sendrecv",sendEncodings:[]};this.options.simulcast&&n.getVideoTracks().length>0&&(s.sendEncodings=[{rid:"h",active:!0,maxBitrate:1e6},{rid:"m",active:!0,maxBitrate:5e5,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:2e5,scaleResolutionDownBy:4}]),n.getAudioTracks().length>0?this.pc.addTransceiver(n.getAudioTracks()[0],a):(a.direction="recvonly",this.pc.addTransceiver("audio",a)),n.getVideoTracks().length>0?this.pc.addTransceiver(n.getVideoTracks()[0],s):(s.direction="recvonly",this.pc.addTransceiver("video",s)),this.pc.createOffer().then(c=>{M(this.TAG,"offer:",c.sdp),this.pc.setLocalDescription(c).then(()=>{ne({method:"post",url:this.options.zlmsdpUrl,responseType:"json",data:c.sdp,headers:{"Content-Type":"text/plain;charset=utf-8"}}).then(p=>{let o=p.data;if(o.code!=0){this.dispatch(x.WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED,o);return}let i={};i.sdp=o.sdp,i.type="answer",M(this.TAG,"answer:",o.sdp),this.pc.setRemoteDescription(i).then(()=>{M(this.TAG,"set remote sucess")}).catch(d=>{N(this.TAG,d)})})})}).catch(c=>{N(this.TAG,c)})}).catch(n=>{this.dispatch(x.CAPTURE_STREAM_FAILED)})}_onIceCandidate(r){r.candidate&&M(`Remote ICE candidate: 
 `+r.candidate.candidate)}_onTrack(r){this.options.element&&r.streams&&r.streams.length>0?(this.options.element.srcObject=r.streams[0],this._remoteStream=r.streams[0],this.dispatch(x.WEBRTC_ON_REMOTE_STREAMS,r)):N("element pararm is failed")}_onIceCandidateError(r){this.dispatch(x.WEBRTC_ICE_CANDIDATE_ERROR,r)}_onconnectionstatechange(r){this.dispatch(x.WEBRTC_ON_CONNECTION_STATE_CHANGE,this.pc.connectionState)}close(){this.pc&&(this.pc.close(),this.pc=null),this.options&&(this.options=null),this._localStream&&this._localStream.getTracks().forEach((r,e)=>{r.stop()}),this._remoteStream&&this._remoteStream.getTracks().forEach((r,e)=>{r.stop()})}get remoteStream(){return this._remoteStream}get localStream(){return this._localStream}}const G=x,jt=Lt,zt=async(t,r,e,n)=>{let a;const s=await fetch(`/api/vms/v1/camera/getByUuid?uuid=${t}`,{method:"GET",headers:{token:n||sessionStorage.getItem("token")||""}}),c=await s.json(),p=await fetch(`/api/vms/v1/camera/getWebrtcUrls?uuid=${t}`,{method:"GET",headers:{token:n||sessionStorage.getItem("token")||""}}),o=await p.json();if(s.status===200){const i=c.data;p.status===200&&(i.webrtcTemplateMerged=o.data[0],i.mediaServerPo.url=o.data[2]);let d=i.webrtcTemplateMerged;a=new Nt({plays:{videoElm:r,videoDom:e,mediaServerAddr:i.mediaServerPo.url,cameraUserName:i.user,cameraPwd:i.pass,cameraIp:i.ip,cameraRtspPort:i.rtspPort,cameraChannel:i.channel,cameraStream:i.streamType,addRtspProxyUrl:d}})}return a};class Nt{constructor(r){this.init(r)}dom;p_player;playerMap=new Map;streamMap=new Map;mediaServerAddrMap=new Map;config={w:100,h:100,endpointConfig:{}};createRtspUrl(r){const{cameraIp:e,cameraRtspPort:n,cameraChannel:a,cameraStream:s,mediaServerAddr:c,addRtspProxyUrl:p}=r;return{stream:`v${e}-${n}-${a}-${s}`,addRtspProxyUrl:p,sdpUrl:c}}init(r){if(r.endpointConfig&&(this.config.endpointConfig=r.endpointConfig),r.h&&(this.config.h=r.h),r.w&&(this.config.w=r.w),Object.prototype.toString.call(r.plays)==="[object Object]")this.p_player=this.createVideo(r.plays);else for(const e of r.plays)this.createVideo(e)}createVideo(r){this.mediaServerAddrMap.set(r.videoElm,r);const{addRtspProxyUrl:e}=this.createRtspUrl(r);return new Promise((n,a)=>{fetch(e,{method:"GET"}).then(s=>{s.json().then(c=>{c.code===0?(this.startPlay(r),n(c)):(this.mediaServerAddrMap.delete(r.videoElm),a(),this.log("err","\u4ECE\u670D\u52A1\u7AEF\u62C9\u6D41\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5"))})})})}log(r,e){switch(r){case"err":throw new Error(e)}}stopPlay(r){if(r){let e=this.playerMap.get(r);e&&(e.close(),this.playerMap.delete(r),this.mediaServerAddrMap.delete(r),e=null)}else this.playerMap.forEach(e=>{e.close(),e=null}),this.playerMap.clear(),this.mediaServerAddrMap.clear()}playEvent(r,e,n){r.on(G.WEBRTC_ICE_CANDIDATE_ERROR,a=>{this.log("err","ICE \u534F\u5546\u51FA\u9519"),this.rePlay(e)}),r.on(G.WEBRTC_ON_REMOTE_STREAMS,a=>{}),r.on(G.WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED,a=>{this.log("warn",`offer anwser \u4EA4\u6362\u5931\u8D25\uFF0C\u83B7\u53D6\u89C6\u9891\u6D41\u5931\u8D25, ${a}`),this.rePlay(e)}),r.on(G.DISCONNECTED,a=>{this.log("warn",`\u4E8B\u4EF6\u68C0\u6D4B\u5230\u8FDE\u63A5\u65AD\u5F00${e}`),this.rePlay(e)}),r.on(G.LOST_SERVER,a=>{this.log("warn",`\u4E8B\u4EF6\u68C0\u6D4B\u5230\u89C6\u9891\u670D\u52A1\u5668\u4E22\u5931${e}`),this.rePlay(e)}),r.on(G.WEBRTC_ON_CONNECTION_STATE_CHANGE,a=>{(a==="disconnected"||a==="failed")&&this.rePlay(e)})}rePlay(r){setTimeout(()=>{this.play(r)},3e3)}play(r){const e=this.mediaServerAddrMap.get(r),{sdpUrl:n}=this.createRtspUrl(e),{w:a,h:s}=this.config,c={element:e.videoDom||document.getElementById(r),debug:!1,zlmsdpUrl:n,simulcast:!1,useCamera:!1,audioEnable:!1,videoEnable:!0,recvOnly:!0,resolution:{w:a,h:s}},p=new jt({...Object.assign(c,this.config.endpointConfig)});this.playEvent(p,r,n),this.playerMap.set(r,p)}startPlay(r){setTimeout(()=>{this.play(r.videoElm)},100)}}function ut(t,r){if(t===null||r===null)return t==r;if(typeof t=="object"&&typeof r=="object"){const e=Object.keys(t),n=Object.keys(r);if(e.length!==n.length)return!1;for(const a of e)if(!ut(t[a],r[a]))return!1;return!0}else return t===r}const V=t=>{const r=t??sessionStorage.getItem("token");if(!r)throw new Error("\u6CA1\u6709token\uFF0C\u4E0D\u80FD\u83B7\u53D6");return{token:r,"Content-Type":"application/json;charset=utf-8"}};function Wt(t){const{token:r,delay:e=5e3,onChange:n,onPolling:a}=t;let s;try{s=V(r)}catch{}let c=null;const p=async()=>{const l=await fetch("/api/alarmlite/v1/record/list",{method:"POST",headers:s,body:JSON.stringify({pageNum:1,pageSize:999,status:"ALARMING"})}),{data:h}=await l.json();return h.records},o=async(l,h,m,y)=>{const T=await fetch(`/api/thing/v1/adapter/thing/relation/findZInstsByClass/${l}/DEVICE_CAMERA`,{method:"GET",headers:s}),{data:v}=await T.json(),g=v.map(E=>({cameraId:E.thingInst.id,cameraCode:E.thingInst.code}));return{alarmId:m,alarmName:y,thingId:l,thingCode:h,cameraList:g}};let i=[];const d=async()=>{const l=await p(),h=!ut(i,l);i=l;const m=l.map(T=>o(T.instanceUuid,T.instanceCode,T.id,T.name)),y=await Promise.all(m);h&&n?.(y,l),a?.(y,l)};d(),c=setInterval(d,e);function u(){c&&clearInterval(c)}return u}const Jt=async(t,r)=>{let e;try{e=V(r)}catch{}return(await fetch("/api/thing/v1/adapter/thing/common/findAlarmDevice",{method:"POST",headers:e,body:JSON.stringify({pageNum:1,pageSize:999,status:"ALARMING"})})).json()},$t=async(t,r)=>{const e=V(r);return(await ne.post("/api/thing/v1/metric/data/getDataList",t,{headers:e})).data.data},Gt=t=>{for(let r of t.detailGroupList)r.thingPropertyValueVoList=r.thingPropertyValueVoList.filter(e=>e.eventEnable);return t},lt=t=>{let r=[];for(let e in t)r.push(e+"="+t[e]);return r.join("&")},Ft=async(t,r)=>{const e=await fetch("/api/mtip/thing/v2/thingInst/findByCodeList?"+lt(r),{method:"POST",headers:V(r.token),body:JSON.stringify(t)}),n={},a=await e.json();if(!a.data)return n;for(let s of t){n[s]=null;for(let c of a.data)if(c.thingInstEntity.code===s)for(let p of c.detailGroupList)for(let o of p.thingPropertyValueVoList)n[s]=Gt(c)}return n},Vt=async(t,r)=>{const e=[];for(let a in t){const s=t[a];if(s)for(let c in s.detailGroupList)for(let p in s.detailGroupList[c].thingPropertyValueVoList)s.detailGroupList[c].thingPropertyValueVoList[p].pointCode&&e.push({pointCode:s.detailGroupList[c].thingPropertyValueVoList[p].pointCode,value:s.detailGroupList[c].thingPropertyValueVoList[p].value})}const n=await(await fetch("/api/mtip/thing/v2/thingInst/reloadPropertiesValue",{method:"POST",headers:V(r),body:JSON.stringify(e)})).json();if(!n.data)return t;for(let a of n.data)for(let s in t){const c=t[s];if(c)for(let p in c.detailGroupList)for(let o in c.detailGroupList[p].thingPropertyValueVoList)c.detailGroupList[p].thingPropertyValueVoList[o].pointCode===a.pointCode&&(c.detailGroupList[p].thingPropertyValueVoList[o].value=a.value)}return t},ht=async(t,r)=>{const e=await Ft(t,r);return async n=>{const a=await Vt(e),s={};if(n&&n.length>0)for(let c in a){const p=a[c];if(p)for(let o in p.detailGroupList)for(let i in p.detailGroupList[o].thingPropertyValueVoList)n.includes(p.detailGroupList[o].thingPropertyValueVoList[i].thingPropertyCode)&&(s[c]={pointCode:p.detailGroupList[o].thingPropertyValueVoList[i].pointCode,value:p.detailGroupList[o].thingPropertyValueVoList[i].value})}return n?s:a}},Ht=async(t,r)=>{const e=await ht(t,r);return()=>e(["DEVICE_STATE"])},Kt=async(t,r)=>{const e=await ht(t,r);return async n=>{const a=await e(),s={};for(let c in a){s[c]={};for(let o of n)s[c][o]=null;const p=a[c];if(p)for(let o in p.detailGroupList)for(let i in p.detailGroupList[o].thingPropertyValueVoList){const d=p.detailGroupList[o].thingPropertyValueVoList[i].thingPropertyCode,u=p.detailGroupList[o].thingPropertyValueVoList[i];n.includes(d)&&(s[c][d]=u)}}return s}},Ut=(t,r)=>{const e={thingInstCode:"",thingInstName:"",pageNum:1,pageSize:100,relaThingCode:"",thingCode:t.thingCode,thingInstId:t.thingInstId,thingRelationId:""};for(let n of t.detailGroupList)for(let a of n.thingPropertyValueVoList)a.thingPropertyCode===r&&(e.thingRelationId=a.value),a.thingPropertyCode===r&&(e.relaThingCode=a.relationThingCode);return e},Xt=async(t,r,e)=>{const n=Ut(t,r),a=await fetch("/api/mtip/thing/v2/thingInst/findRelationEntitiesPage?"+lt(e),{headers:V(e.token),method:"POST",body:JSON.stringify(n)}),s=[],c=await a.json();if(!c.data)return{deviceCodeList:s,resData:c};for(let p of c.data.list)for(let o of p.listPropertyList)o.thingPropertyCode==="CODE"&&s.push(o.value);return{deviceCodeList:s,resData:c}};export{Ft as GetDeviceDetailOnce,Kt as InjectDeveiceCodeGetDetailByPc,ht as InjectDeviceCodeGetDetail,Ht as InjectDeviceCodeGetState,Vt as RefreshDeviceDetail,Nt as WebRtcMt,Gt as filterDataByEventEnable,Jt as findAlarmDeviceById,Xt as findRelationEntitiesPage,Wt as getAlarmingCamera,Ut as getCorrelationInts,$t as getDeviceList,zt as playOneWebRtcMt};
